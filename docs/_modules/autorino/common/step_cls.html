

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>autorino.common.step_cls &mdash; autorino  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../../../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/dark_mode_js/default_dark.js?v=fd565c74"></script>
      <script src="../../../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo_autorino.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to autorino’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_converters.html">External GNSS converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cookbook.html"><em>autorino</em>’s exemple cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_files_nutshell.html">Configuration files in a nutshell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_files_details.html">Configuration file details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../under_hood.html">Under the hood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autorino.html">autorino package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">autorino</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">autorino.common.step_cls</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for autorino.common.step_cls</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Jan  8 16:53:51 2024</span>

<span class="sd">@author: psakic</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">filelock</span> <span class="kn">import</span> <span class="n">FileLock</span><span class="p">,</span> <span class="n">Timeout</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">autorino.common</span> <span class="k">as</span> <span class="nn">arocmn</span>
<span class="kn">import</span> <span class="nn">autorino.cfglog</span> <span class="k">as</span> <span class="nn">arologcfg</span>
<span class="kn">import</span> <span class="nn">rinexmod</span>

<span class="kn">from</span> <span class="nn">geodezyx</span> <span class="kn">import</span> <span class="n">utils</span><span class="p">,</span> <span class="n">conv</span>
<span class="kn">from</span> <span class="nn">rinexmod</span> <span class="kn">import</span> <span class="n">rinexmod_api</span>

<span class="c1">#### Import the logger</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">autorino.cfgenv.env_read</span> <span class="k">as</span> <span class="nn">aroenv</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;autorino&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">aroenv</span><span class="o">.</span><span class="n">ARO_ENV_DIC</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;log_level&quot;</span><span class="p">])</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>

<span class="c1"># from logging_tree import printout</span>
<span class="c1"># print(&quot;Logging Tree:&quot;, printout())</span>


<div class="viewcode-block" id="StepGnss">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss">[docs]</a>
<span class="k">class</span> <span class="nc">StepGnss</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The StepGnss class represents a step in a GNSS processing chain.</span>
<span class="sd">    It contains methods for initializing and managing</span>
<span class="sd">    various aspects of a processing step, including epoch ranges,</span>
<span class="sd">    sites, sessions, options, and metadata. It also provides</span>
<span class="sd">    methods for handling temporary directories, logging,</span>
<span class="sd">    and table management.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    out_dir : str</span>
<span class="sd">        The output directory for the step.</span>
<span class="sd">    tmp_dir : str</span>
<span class="sd">        The temporary directory for the step.</span>
<span class="sd">    log_dir : str</span>
<span class="sd">        The log directory for the step.</span>
<span class="sd">    epoch_range : EpochRange</span>
<span class="sd">        The epoch range for the step.</span>
<span class="sd">    site : dict</span>
<span class="sd">        The site information for the step.</span>
<span class="sd">    session : dict</span>
<span class="sd">        The session information for the step.</span>
<span class="sd">    options : dict</span>
<span class="sd">        The options for the step.</span>
<span class="sd">    metadata : str or list, optional</span>
<span class="sd">        The metadata to be included in the converted RINEX files. Possible inputs are:</span>
<span class="sd">         * list of string (sitelog file paths),</span>
<span class="sd">         * single string (single sitelog file path)</span>
<span class="sd">         * single string (directory containing the sitelogs)</span>
<span class="sd">         * list of MetaData objects</span>
<span class="sd">         * single MetaData object.</span>
<span class="sd">         Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="StepGnss.__init__">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tmp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inp_file_regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">epoch_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a new instance of the StepGnss class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        out_dir : str</span>
<span class="sd">            The output directory for the step.</span>
<span class="sd">        tmp_dir : str</span>
<span class="sd">            The temporary directory for the step.</span>
<span class="sd">        log_dir : str</span>
<span class="sd">            The log directory for the step.</span>
<span class="sd">        inp_dir : str</span>
<span class="sd">            The input directory for the step.</span>
<span class="sd">        inp_file_regex : str</span>
<span class="sd">            The regular expression pattern for the input files. Default is &#39;.*&#39; (everything).</span>
<span class="sd">        epoch_range : EpochRange, optional</span>
<span class="sd">            The epoch range for the step. If not provided, a dummy epoch range is created.</span>
<span class="sd">        site : dict, optional</span>
<span class="sd">            The site information for the step. If not provided, a dummy site is created.</span>
<span class="sd">        session : dict, optional</span>
<span class="sd">            The session information for the step. If not provided, a dummy session is created.</span>
<span class="sd">        options : dict, optional</span>
<span class="sd">            The options for the step. If not provided, an empty options dictionary is created.</span>
<span class="sd">        metadata : str or list, optional</span>
<span class="sd">            The metadata to be included in the converted RINEX files. Possible inputs are:</span>
<span class="sd">             * list of string (sitelog file paths),</span>
<span class="sd">             * single string (single sitelog file path)</span>
<span class="sd">             * single string (directory containing the sitelogs)</span>
<span class="sd">             * list of MetaData objects</span>
<span class="sd">             * single MetaData object.</span>
<span class="sd">             Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialized in the next line = these attributes use both a setter and an _init method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_epoch_range</span><span class="p">(</span><span class="n">epoch_range</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_site</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_site_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_dict</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_translate_dict</span><span class="p">()</span>

        <span class="c1">### sitelog init (needs translate dict)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tmp_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inp_dir</span> <span class="o">=</span> <span class="n">inp_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inp_file_regex</span> <span class="o">=</span> <span class="n">inp_file_regex</span> <span class="k">if</span> <span class="n">inp_file_regex</span> <span class="k">else</span> <span class="s2">&quot;.*&quot;</span>

        <span class="c1">### temp dirs init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_tables</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_converted</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_downloaded</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># initialized in the next line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_tmp_dirs_paths</span><span class="p">()</span>

        <span class="c1"># generic log must be on request, to avoid nasty effects</span>
        <span class="c1"># (missing lines in the log file, and extra lines in the console, i.e. a mess)</span>
        <span class="c1"># self.set_logfile()</span>

        <span class="c1"># table log is on request only (for the moment)</span>
        <span class="c1"># thus this table_log_path attribute must be initialized as none</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_log_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#### list to stack temporarily the temporary files before their delete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_rnx_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_decmp_files</span> <span class="o">=</span> <span class="p">[]</span></div>


    <span class="c1"># getter and setter</span>
    <span class="c1"># site_id</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> elts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">out_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_out_dir</span><span class="p">)</span>

    <span class="nd">@out_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">out_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;output directory is not defined (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_out_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir</span><span class="p">)</span>

    <span class="nd">@tmp_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tmp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;temp directory is not defined (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_dir</span><span class="p">)</span>

    <span class="nd">@log_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">log_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;log directory is not defined (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inp_dir</span><span class="p">)</span>

    <span class="nd">@inp_dir</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">inp_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;input directory is not defined (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inp_dir</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">### site</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span>

    <span class="nd">@site_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">site_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_id4</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site_id</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site_id9</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">make_site_id9</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">)</span>

    <span class="c1"># epoch_range_inp</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epoch_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_range</span>

    <span class="nd">@epoch_range</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">epoch_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epoch_range</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># table</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

    <span class="nd">@table</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># designed for future safety tests</span>

<div class="viewcode-block" id="StepGnss._init_table">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_table">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_cols</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">init_epoch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the table of a StepGnss object.</span>

<span class="sd">        This method creates a new pandas DataFrame with specified columns. If no columns are provided,</span>
<span class="sd">        it creates a DataFrame with default columns. If `init_epoch` is True, it also initializes the</span>
<span class="sd">        &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns with the epoch range of the StepGnss object and the &#39;site&#39;</span>
<span class="sd">        column with the site ID of the StepGnss object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table_cols : list of str, optional</span>
<span class="sd">            The columns to include in the table. If not provided, default columns are used.</span>
<span class="sd">        init_epoch : bool, optional</span>
<span class="sd">            If True, initializes the &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns with the epoch range of the</span>
<span class="sd">            StepGnss object and the &#39;site&#39; column with the site ID of the StepGnss object. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;fname&quot;</span><span class="p">,</span>
                <span class="s2">&quot;site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;epoch_srt&quot;</span><span class="p">,</span>
                <span class="s2">&quot;epoch_end&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ok_inp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ok_out&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fpath_inp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fpath_out&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size_inp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size_out&quot;</span><span class="p">,</span>
                <span class="s2">&quot;note&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="n">table_cols</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">init_epoch</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">eporng_list</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">eporng_list</span><span class="p">(</span><span class="n">end_bound</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_site">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_site">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the site attribute of the StepGnss object.</span>

<span class="sd">        If a site dictionary is not provided, a warning is logged and a dummy site dictionary is created and set as the</span>
<span class="sd">        site attribute.</span>
<span class="sd">        If a site dictionary is provided, it is set as the site attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site : dict, optional</span>
<span class="sd">            The site information for the step. If not provided, a dummy site is created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">site</span><span class="p">:</span>
            <span class="c1"># logger.warning(&quot;no site dict given, a dummy one will be created&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">dummy_site_dic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_session">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_session">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the session attribute of the StepGnss object.</span>

<span class="sd">        If a session dictionary is not provided, a warning is logged and a dummy session dictionary is created</span>
<span class="sd">        and set as the session attribute.</span>
<span class="sd">        If a session dictionary is provided, it is set as the session attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        session : dict, optional</span>
<span class="sd">            The session information for the step. If not provided, a dummy session is created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># logger.warning(&quot;no session dict given, a dummy one will be created&quot;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">dummy_sess_dic</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_options">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_options">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the options attribute of the StepGnss object.</span>

<span class="sd">        This method sets the options attribute of the StepGnss object. If an options dictionary is not provided,</span>
<span class="sd">        it creates an empty dictionary and sets it as the options attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        options : dict, optional</span>
<span class="sd">            The options for the step. If not provided, an empty dictionary is created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_site_id">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_site_id">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_site_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the site_id attribute of the StepGnss object.</span>

<span class="sd">        This method checks if a &#39;site_id&#39; is provided in the site dictionary.</span>
<span class="sd">        If it is, it sets the &#39;site_id&#39; attribute of the StepGnss object to the provided &#39;site_id&#39;.</span>
<span class="sd">        If a &#39;site_id&#39; is not provided, it sets the &#39;site_id&#39; attribute to &#39;XXXX00XX00XXXX&#39; as a default value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;site_id&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">[</span><span class="s2">&quot;site_id&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="s2">&quot;XXXX00XXX&quot;</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_epoch_range">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_epoch_range">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_epoch_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch_range</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the epoch range of the StepGnss object.</span>

<span class="sd">        This method sets the epoch range of the StepGnss object.</span>
<span class="sd">        If an epoch range is provided, it interprets the epoch range using the `epoch_range_intrpt` function</span>
<span class="sd">        from the `arocmn` module.</span>
<span class="sd">        If an epoch range is not provided, it creates a dummy epoch range between &#39;NaT&#39; (not a time) using</span>
<span class="sd">        the `EpochRange` function from the `arocmn` module.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        epoch_range : str, optional</span>
<span class="sd">            The epoch range for the step. If not provided, a dummy epoch range is created.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">epoch_range</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">epoch_range_intrpt</span><span class="p">(</span><span class="n">epoch_range</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">EpochRange</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_tmp_dirs_paths">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_tmp_dirs_paths">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_tmp_dirs_paths</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tmp_subdir_dwnld</span><span class="o">=</span><span class="s2">&quot;010_downloaded&quot;</span><span class="p">,</span>
        <span class="n">tmp_subdir_unzip</span><span class="o">=</span><span class="s2">&quot;020_unzipped&quot;</span><span class="p">,</span>
        <span class="n">tmp_subdir_conv</span><span class="o">=</span><span class="s2">&quot;030_converted&quot;</span><span class="p">,</span>
        <span class="n">tmp_subdir_rnxmod</span><span class="o">=</span><span class="s2">&quot;040_rinexmoded&quot;</span><span class="p">,</span>
        <span class="n">tmp_subdir_tables</span><span class="o">=</span><span class="s2">&quot;090_tables&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the temporary directories paths as attribute for the StepGnss object.</span>

<span class="sd">        This method is internal only, for the initialisation of the StepGnss object.</span>

<span class="sd">        See set_tmp_dirs for the actual creation of the directories.</span>

<span class="sd">        This method sets the paths for the temporary directories of the StepGnss object.</span>
<span class="sd">        It creates the paths in a generic form, with placeholders and without creating the actual directories.</span>
<span class="sd">        The directories include logs, unzipped, converted, rinexmoded, and downloaded directories.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tmp_subdir_dwnld : str, optional</span>
<span class="sd">            The subdirectory for downloaded files. Default is &#39;downloaded&#39;.</span>
<span class="sd">        tmp_subdir_unzip : str, optional</span>
<span class="sd">            The subdirectory for unzipped files. Default is &#39;unzipped&#39;.</span>
<span class="sd">        tmp_subdir_conv : str, optional</span>
<span class="sd">            The subdirectory for converted files. Default is &#39;converted&#39;.</span>
<span class="sd">        tmp_subdir_rnxmod : str, optional</span>
<span class="sd">            The subdirectory for rinexmoded files. Default is &#39;rinexmoded&#39;.</span>
<span class="sd">        tmp_subdir_tables : str, optional</span>
<span class="sd">            The subdirectory for logs. Default is &#39;logs&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Internal versions have not been translated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_downloaded</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmp_subdir_dwnld</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_unzipped</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmp_subdir_unzip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_converted</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmp_subdir_conv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_rinexmoded</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmp_subdir_rnxmod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_tables</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">tmp_subdir_tables</span><span class="p">)</span>

        <span class="c1"># Translation of the paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_downloaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_downloaded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_unzipped</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_converted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_rinexmoded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_tables</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss._init_metadata">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss._init_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">_init_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the metadata attribute of the StepGnss object.</span>

<span class="sd">        This method checks if a &#39;metadata&#39; is provided. If it is, it translates the path of the metadata,</span>
<span class="sd">        manages the site log input using the `metadata_input_manage` function from the `rinexmod_api` module,</span>
<span class="sd">        and sets the &#39;metadata&#39; attribute of the StepGnss object to the managed site log input.</span>
<span class="sd">        If a &#39;metadata&#39; is not provided, it sets the &#39;metadata&#39; attribute to None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metadata : str, optional</span>
<span class="sd">            The metadata for the step. If not provided, the &#39;metadata&#39; attribute is set to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># the input is a str, i.e. a path</span>
                <span class="n">metadata_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># all the other cases, i.e. already some MetaData objects</span>
                <span class="n">metadata_set</span> <span class="o">=</span> <span class="n">metadata</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">rinexmod_api</span><span class="o">.</span><span class="n">metadata_input_manage</span><span class="p">(</span>
                <span class="n">metadata_set</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.set_translate_dict">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.set_translate_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">set_translate_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the translation dictionary based on the site and session dictionaries,</span>
<span class="sd">        object attributes, and site id.</span>

<span class="sd">        The translation dictionary is used to replace placeholders in the path strings with actual values.</span>
<span class="sd">        It includes keys for each attribute in the site and session dictionaries, as well as for the site id.</span>
<span class="sd">        The site id has three variations: &#39;site_id&#39;, &#39;site_id4&#39;, and &#39;site_id9&#39;, each in both lower and upper case.</span>

<span class="sd">        The method does not take any parameters and does not return any value.</span>
<span class="sd">        It directly modifies the &#39;translate_dict&#39; attribute of the object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">trsltdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Add each attribute from the site and session dictionaries to the translation dictionary</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">trsltdict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="n">trsltdict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trsltdict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">trsltdict</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c1"># Add each variation of the site id to the translation dictionary</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;site_id4&quot;</span><span class="p">,</span> <span class="s2">&quot;site_id9&quot;</span><span class="p">):</span>
            <span class="n">trsltdict</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">trsltdict</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Update the translate_dict attribute of the object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_dict</span> <span class="o">=</span> <span class="n">trsltdict</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.set_tmp_dirs">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.set_tmp_dirs">[docs]</a>
    <span class="k">def</span> <span class="nf">set_tmp_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translates and creates temporary directories.</span>

<span class="sd">        This method translates the paths of the temporary directories and creates them if they do not exist.</span>
<span class="sd">        The directories include logs, unzipped, converted, rinexmoded, and downloaded directories.</span>
<span class="sd">        The paths are translated using the `translate_path` method of the StepGnss object, which replaces placeholders</span>
<span class="sd">        in the paths with actual values.</span>
<span class="sd">        The directories are created if the `make_dir` parameter of the `translate_path` method is set to True.</span>

<span class="sd">        Note: This translation is also done in the `_init_tmp_dirs_paths` method, but it is redone here</span>
<span class="sd">        to ensure accuracy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            A tuple containing the paths of the downloaded, unzipped, converted, rinexmoded, and logs directories,</span>
<span class="sd">            in that order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This translation is also done in _init_tmp_dirs_paths</span>
        <span class="c1"># but we redo it here, simply to be sure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_downloaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_downloaded</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_unzipped</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_converted</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_rinexmoded</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tmp_dir_tables</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_downloaded</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_converted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_tables</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="StepGnss.clean_tmp_dirs">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.clean_tmp_dirs">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_tmp_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">keep_table_logs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans the temporary directories of the StepGnss object.</span>

<span class="sd">        This method removes all files older than a specified number of days in the temporary</span>
<span class="sd">        directories of the StepGnss object.</span>
<span class="sd">        The directories include logs, unzipped, converted, rinexmoded, and downloaded directories.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        remov_tmp_files : Cleans the files in the temporary directories at the end of the processing</span>
<span class="sd">                          based on ad hoc lists.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        days : int, optional</span>
<span class="sd">            The number of days to use as the threshold for deleting old files. Default is 7 days.</span>
<span class="sd">        keep_table_logs : bool, optional</span>
<span class="sd">            If True, keeps the table logs sotored in the tmp directories.</span>
<span class="sd">            Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">age_threshold</span> <span class="o">=</span> <span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span>  <span class="c1"># Convert days to seconds</span>

        <span class="c1"># Iterate through the temporary directories</span>
        <span class="k">for</span> <span class="n">tmp_dir</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_downloaded</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_converted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_tables</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">keep_table_logs</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;table.log&quot;</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="n">file_age</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_age</span> <span class="o">&gt;</span> <span class="n">age_threshold</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Deleted old file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1">#   _____                           _                  _   _               _</span>
    <span class="c1">#  / ____|                         | |                | | | |             | |</span>
    <span class="c1"># | |  __  ___ _ __   ___ _ __ __ _| |  _ __ ___   ___| |_| |__   ___   __| |___</span>
    <span class="c1"># | | |_ |/ _ \ &#39;_ \ / _ \ &#39;__/ _` | | | &#39;_ ` _ \ / _ \ __| &#39;_ \ / _ \ / _` / __|</span>
    <span class="c1"># | |__| |  __/ | | |  __/ | | (_| | | | | | | | |  __/ |_| | | | (_) | (_| \__ \</span>
    <span class="c1">#  \_____|\___|_| |_|\___|_|  \__,_|_| |_| |_| |_|\___|\__|_| |_|\___/ \__,_|___/</span>

<div class="viewcode-block" id="StepGnss.copy">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a duplicate of the current StepGnss object.</span>

<span class="sd">        This method uses the deepcopy function from the copy module to create a new instance of the StepGnss class that is a</span>
<span class="sd">        complete copy of the current instance. All attributes of the current instance are copied to the new instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        StepGnss</span>
<span class="sd">            A new instance of the StepGnss class that is a copy of the current instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">out_copy</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out_copy</span></div>


<div class="viewcode-block" id="StepGnss.get_step_type">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.get_step_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_step_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_object_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the type of the step as a string.</span>

<span class="sd">        This method is used to identify the type of the current step in the GNSS processing chain.</span>
<span class="sd">        It returns the name of the class to which the current instance belongs. If the &#39;full_object_name&#39;</span>
<span class="sd">        parameter is False, it returns a shortened version of the class name, in lower case and without</span>
<span class="sd">        the &#39;Gnss&#39; suffix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        full_object_name : bool, optional</span>
<span class="sd">            If True, the full name of the class is returned. If False, a shortened version of the class name,</span>
<span class="sd">            in lower case, and without the &#39;Gnss&#39; suffix.</span>
<span class="sd">            Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The name of the class to which the current instance belongs. If &#39;full_object_name&#39; is False,</span>
<span class="sd">            the last 4 characters are removed from the class name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">full_object_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># without Gnss suffix</span></div>


<div class="viewcode-block" id="StepGnss.updt_site_w_rnx_fname">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.updt_site_w_rnx_fname">[docs]</a>
    <span class="k">def</span> <span class="nf">updt_site_w_rnx_fname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the site information in the table and</span>
<span class="sd">        in the &#39;site_id&#39; object based on the RINEX filenames.</span>

<span class="sd">        This method iterates over each row in the table and</span>
<span class="sd">        updates the &#39;site&#39; column with the first 9 characters</span>
<span class="sd">        of the &#39;fname&#39; column if the filename matches the RINEX regex pattern.</span>
<span class="sd">        It then updates the &#39;site_id&#39; attribute of the StepGnss object</span>
<span class="sd">        based on the unique site values in the table.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">conv</span><span class="o">.</span><span class="n">rinex_regex_search_tester</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">][:</span><span class="mi">9</span><span class="p">]</span>

        <span class="n">sites_uniq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_uniq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">=</span> <span class="n">sites_uniq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites_uniq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;unable to update site_id, multiple sites </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sites_uniq</span><span class="p">,</span> <span class="bp">self</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unable to update site_id, no site found in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.updt_epotab_tz">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.updt_epotab_tz">[docs]</a>
    <span class="k">def</span> <span class="nf">updt_epotab_tz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the epoch table with the specified timezone.</span>

<span class="sd">        This method updates the &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns</span>
<span class="sd">        of the epoch table with the specified timezone.</span>
<span class="sd">        It uses the &#39;tz&#39; parameter to set the timezone</span>
<span class="sd">        for the epoch table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tz : str, optional</span>
<span class="sd">            The timezone to be applied to the epoch table.</span>
<span class="sd">            Default is &#39;UTC&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">epo</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">,</span> <span class="s2">&quot;epoch_end&quot;</span><span class="p">]:</span>
            <span class="c1"># not TZ aware =&gt; we add the TZ to make it TZ aware</span>
            <span class="c1"># if not pd.api.types.is_datetime64tz_dtype(self.table[epo]): ### old test</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">epo</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeTZDtype</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">epo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">epo</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>
            <span class="c1"># TZ aware already =&gt; we convert it to the new TZ</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">epo</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">epo</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="n">tz</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.updt_epotab_rnx">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.updt_epotab_rnx">[docs]</a>
    <span class="k">def</span> <span class="nf">updt_epotab_rnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_rnx_filename_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_epoch_range</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the StepGnss table&#39;s columns &#39;epoch_srt&#39; and &#39;epoch_end&#39; based on the RINEX files.</span>

<span class="sd">        If the StepGnss object contains RINEX files, this function updates the &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns</span>
<span class="sd">        of the StepGnss table based on the RINEX files. The start and end epochs and the period of the RINEX file</span>
<span class="sd">        can be determined based on its name only (if use_rnx_filename_only is True). This function is much faster</span>
<span class="sd">        but less reliable. At the end of the table update, it can also update the EpochRange object associated to</span>
<span class="sd">        the StepGnss object (if update_epoch_range is True).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_rnx_filename_only : bool, optional</span>
<span class="sd">            If True, determines the start epoch, the end epoch and the period of the RINEX file based on its name only.</span>
<span class="sd">            The RINEX file is not read. This function is much faster but less reliable. Default is False.</span>
<span class="sd">        update_epoch_range : bool, optional</span>
<span class="sd">            If True, at the end of the table update, also updates the EpochRange object associated to</span>
<span class="sd">            the StepGnss object.</span>
<span class="sd">            This is recommended. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_rnx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">rinex_regex_search_tester</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_rnx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;epoch update impossible, no file matches a RINEX pattern in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use_rnx_filename_only</span><span class="p">:</span>
                <span class="n">rnx</span> <span class="o">=</span> <span class="n">rinexmod</span><span class="o">.</span><span class="n">rinexfile</span><span class="o">.</span><span class="n">RinexFile</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">])</span>
                <span class="n">epo_srt</span> <span class="o">=</span> <span class="n">rnx</span><span class="o">.</span><span class="n">start_date</span>
                <span class="n">epo_end</span> <span class="o">=</span> <span class="n">rnx</span><span class="o">.</span><span class="n">end_date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epo_srt</span><span class="p">,</span> <span class="n">epo_end</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">rinexmod</span><span class="o">.</span><span class="n">rinexfile</span><span class="o">.</span><span class="n">dates_from_rinex_filename</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epo_srt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epo_end</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">])</span>

        <span class="c1"># update the timezone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updt_epotab_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_epoch_range</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;update the epoch range from </span><span class="si">%i</span><span class="s2"> RINEX filenames&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updt_eporng_tab</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.updt_eporng_tab">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.updt_eporng_tab">[docs]</a>
    <span class="k">def</span> <span class="nf">updt_eporng_tab</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">column_srt</span><span class="o">=</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">,</span> <span class="n">column_end</span><span class="o">=</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">,</span> <span class="n">round_method</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the EpochRange of the StepGnss object based on the min/max epochs in the object&#39;s table.</span>

<span class="sd">        This function calculates the minimum and maximum epochs from the specified columns in the table.</span>
<span class="sd">        It then calculates the most common period (time difference between start and end epochs) in the table.</span>
<span class="sd">        The function updates the EpochRange of the StepGnss object with these calculated values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        column_srt : str, optional</span>
<span class="sd">            The name of the column in the table that contains the start epochs. Default is &#39;epoch_srt&#39;.</span>
<span class="sd">        column_end : str, optional</span>
<span class="sd">            The name of the column in the table that contains the end epochs. Default is &#39;epoch_end&#39;.</span>
<span class="sd">        round_method : str, optional</span>
<span class="sd">            The method used for rounding the epochs. The default is &#39;none&#39;.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the period spacing in the table is not uniform, the function will keep the most common period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epomin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">column_srt</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">epomax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">column_end</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">epoch1</span> <span class="o">=</span> <span class="n">epomin</span>
        <span class="n">epoch2</span> <span class="o">=</span> <span class="n">epomax</span>

        <span class="n">tdelta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">column_end</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">column_srt</span><span class="p">]</span>

        <span class="n">n_tdelta</span> <span class="o">=</span> <span class="n">tdelta</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="n">v_tdelta</span> <span class="o">=</span> <span class="n">tdelta</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">period_new</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">timedelta2freq_alias</span><span class="p">(</span><span class="n">v_tdelta</span><span class="p">)</span>
        <span class="c1"># logger.debug(&quot;new period, %s, %s&quot;, v_tdelta, period_new)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_tdelta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;not uniform period spacing of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%i</span><span class="s2"> val.), keep the most common: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%i</span><span class="s2"> occur.)&quot;</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">n_tdelta</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">v_tdelta</span><span class="p">),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">n_tdelta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>  <span class="c1"># HERE IS DEPRECATION WARNING PANDAS</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">EpochRange</span><span class="p">(</span>
            <span class="n">epoch1</span><span class="p">,</span>
            <span class="n">epoch2</span><span class="p">,</span>
            <span class="n">period_new</span><span class="p">,</span>
            <span class="n">round_method</span><span class="o">=</span><span class="n">round_method</span><span class="p">,</span>
            <span class="c1"># round_method=self.epoch_range.round_method,</span>
            <span class="n">tz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">tz</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;new epoch range </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.translate_path">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.translate_path">[docs]</a>
    <span class="k">def</span> <span class="nf">translate_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path_inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">epoch_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">make_dir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translates a given path using the object&#39;s translation dictionary and optionally creates the directory.</span>

<span class="sd">        This function is able to create a directory corresponding to the translated path if `make_dir` is True.</span>
<span class="sd">        Warning: it creates the directory as it is! (no dirname extraction)</span>
<span class="sd">        If the translated path is a full path with a filename, you will get nasty results!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_inp : str</span>
<span class="sd">            The input path to be translated.</span>
<span class="sd">        epoch_inp : datetime, optional</span>
<span class="sd">            The epoch input to be used in the translation. Default is None.</span>
<span class="sd">        make_dir : bool, optional</span>
<span class="sd">            If True, the function will create the directory corresponding to the translated path.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        absolute : bool, optional</span>
<span class="sd">            If True, the function will return the absolute path. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The translated directory path.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The function uses the `translator` function from the `arocmn` module to perform the translation.</span>

<span class="sd">        for translation of attribute self.inp_file_rinex, use also this method</span>
<span class="sd">        (we decide to not create a dedicated method for this)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trslt_path_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_core</span><span class="p">(</span>
            <span class="n">path_inp</span><span class="o">=</span><span class="n">path_inp</span><span class="p">,</span>
            <span class="n">trslt_dic_use</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">translate_dict</span><span class="p">,</span>
            <span class="n">epoch_use</span><span class="o">=</span><span class="n">epoch_inp</span><span class="p">,</span>
            <span class="n">make_dir</span><span class="o">=</span><span class="n">make_dir</span><span class="p">,</span>
            <span class="n">absolute</span><span class="o">=</span><span class="n">absolute</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">trslt_path_out</span></div>


<div class="viewcode-block" id="StepGnss.translate_path_row">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.translate_path_row">[docs]</a>
    <span class="k">def</span> <span class="nf">translate_path_row</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path_inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">irow</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">make_dir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">absolute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translates a given path using the object&#39;s translation dictionary for a specific row in the table.</span>

<span class="sd">        This function translates the input path using the translation dictionary specific to the site ID</span>
<span class="sd">        of the row indicated by `irow`. It optionally creates the directory and returns the absolute path.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_inp : str</span>
<span class="sd">            The input path to be translated.</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table to use for translation.</span>
<span class="sd">            Will override the StepGnss translate_dict.</span>
<span class="sd">        make_dir : bool, optional</span>
<span class="sd">            If True, the function will create the directory corresponding to the translated path. Default is False.</span>
<span class="sd">        absolute : bool, optional</span>
<span class="sd">            If True, the function will return the absolute path. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The translated directory path.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">epoch_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span>
        <span class="n">trslt_dic_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trslt_dic_siteid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">irow</span><span class="p">])</span>

        <span class="n">trslt_path_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_core</span><span class="p">(</span>
            <span class="n">path_inp</span><span class="o">=</span><span class="n">path_inp</span><span class="p">,</span>
            <span class="n">trslt_dic_use</span><span class="o">=</span><span class="n">trslt_dic_use</span><span class="p">,</span>
            <span class="n">epoch_use</span><span class="o">=</span><span class="n">epoch_use</span><span class="p">,</span>
            <span class="n">make_dir</span><span class="o">=</span><span class="n">make_dir</span><span class="p">,</span>
            <span class="n">absolute</span><span class="o">=</span><span class="n">absolute</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">trslt_path_out</span></div>


<div class="viewcode-block" id="StepGnss.trslt_dic_siteid">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.trslt_dic_siteid">[docs]</a>
    <span class="k">def</span> <span class="nf">trslt_dic_siteid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_id_inp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an ad hoc translation dictionary with given site IDs.</span>

<span class="sd">        This function returns an ad hoc translation dictionary with the site ID in different formats.</span>
<span class="sd">        It adds the site ID in 4-character and 9-character formats, both in upper and lower case.</span>
<span class="sd">        If the site ID ends with &#39;XXX&#39;, it uses the 4-character format for the &#39;site_id&#39; key.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site_id_inp : str</span>
<span class="sd">            The site ID to be used for updating the translation dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        trsltdict_out : dict</span>
<span class="sd">            The updated translation dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trsltdict_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">site9_use</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">make_site_id9</span><span class="p">(</span><span class="n">site_id_inp</span><span class="p">)</span>
        <span class="n">site4_use</span> <span class="o">=</span> <span class="n">site9_use</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;site_id4&quot;</span>
        <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site4_use</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site4_use</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;site_id9&quot;</span>
        <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site9_use</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site9_use</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;site_id&quot;</span>
        <span class="k">if</span> <span class="n">site9_use</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;XXX&quot;</span><span class="p">):</span>
            <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site4_use</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site4_use</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site9_use</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">trsltdict_out</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">site9_use</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">trsltdict_out</span></div>


<div class="viewcode-block" id="StepGnss.translate_core">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.translate_core">[docs]</a>
    <span class="k">def</span> <span class="nf">translate_core</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path_inp</span><span class="p">,</span> <span class="n">trslt_dic_use</span><span class="p">,</span> <span class="n">epoch_use</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">trslt_path_out</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">translator</span><span class="p">(</span><span class="n">path_inp</span><span class="p">,</span> <span class="n">trslt_dic_use</span><span class="p">,</span> <span class="n">epoch_use</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">make_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">trslt_path_out</span><span class="p">):</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">trslt_path_out</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;directory created: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">trslt_path_out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trslt_path_out</span> <span class="ow">and</span> <span class="n">absolute</span><span class="p">:</span>
            <span class="n">trslt_path_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">trslt_path_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trslt_path_out</span></div>


<div class="viewcode-block" id="StepGnss.create_lockfile">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.create_lockfile">[docs]</a>
    <span class="k">def</span> <span class="nf">create_lockfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1800</span><span class="p">,</span> <span class="n">prefix_lockfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a lock file for the specified file path.</span>

<span class="sd">        This method attempts to acquire a lock on the specified file. If the lock is acquired,</span>
<span class="sd">        it prints a success message.</span>
<span class="sd">        If the lock is not acquired (i.e., the file is already locked),</span>
<span class="sd">        it prints a message indicating that the process is locked.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout : int, optional</span>
<span class="sd">            The timeout period in seconds to wait for acquiring the lock. Default is 1800 seconds.</span>
<span class="sd">        prefix_lockfile : str, optional</span>
<span class="sd">            The prefix to use for the lock file name. If not provided, a random integer is used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FileLock</span>
<span class="sd">            The FileLock object representing the lock on the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix_lockfile</span><span class="p">:</span>
            <span class="n">prefix_lockfile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;access&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;datalink&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">:</span>
                <span class="n">prefix_lockfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">[</span><span class="s2">&quot;datalink&quot;</span><span class="p">]</span>

        <span class="n">lockfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">prefix_lockfile</span> <span class="o">+</span> <span class="s2">&quot;_lock&quot;</span><span class="p">)</span>

        <span class="c1"># a preliminary check to see if a previous lock exists</span>
        <span class="n">arocmn</span><span class="o">.</span><span class="n">check_lockfile</span><span class="p">(</span><span class="n">lockfile_path</span><span class="p">)</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">FileLock</span><span class="p">(</span><span class="n">lockfile_path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lock acquired for </span><span class="si">{</span><span class="n">lockfile_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Timeout</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Process still locked after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> s for </span><span class="si">{</span><span class="n">lockfile_path</span><span class="si">}</span><span class="s2">, aborting&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">lock</span></div>


    <span class="c1">#  _                       _</span>
    <span class="c1"># | |                     (_)</span>
    <span class="c1"># | |     ___   __ _  __ _ _ _ __   __ _</span>
    <span class="c1"># | |    / _ \ / _` |/ _` | | &#39;_ \ / _` |</span>
    <span class="c1"># | |___| (_) | (_| | (_| | | | | | (_| |</span>
    <span class="c1"># |______\___/ \__, |\__, |_|_| |_|\__, |</span>
    <span class="c1">#               __/ | __/ |         __/ |</span>
    <span class="c1">#              |___/ |___/         |___/</span>

<div class="viewcode-block" id="StepGnss.set_logfile">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.set_logfile">[docs]</a>
    <span class="k">def</span> <span class="nf">set_logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_dir_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_suffix</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set logging in a file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">log_dir_inp</span><span class="p">:</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_tmp_dirs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir_inp</span>

        <span class="k">if</span> <span class="n">step_suffix</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">step_suffix_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_type</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step_suffix_use</span> <span class="o">=</span> <span class="n">step_suffix</span>

        <span class="n">log_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>

        <span class="c1">#### save the root (empty parenthesis) to catch autorino + rinexmod logs</span>
        <span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="c1"># this getlogger has a nasty side effect: it creates a new handler</span>
        <span class="c1"># and then duplcated message pollute the console</span>
        <span class="c1"># https://stackoverflow.com/questions/19561058/python-logging-module-is-printing-lines-multiple-times</span>
        <span class="c1"># The easiest solution is to set propagate to False, but then nothing is writed in the log file</span>
        <span class="c1"># Thus we must clear the existing handlers</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear existing handlers</span>
        <span class="c1"># https://santos-k.medium.com/solving-duplicate-log-entries-issue-in-python-logging-d4b1cad8e588</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>
        <span class="n">logfile_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ts</span><span class="p">,</span> <span class="s2">&quot;autorino&quot;</span><span class="p">,</span> <span class="n">step_suffix_use</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="n">logfile_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir_use</span><span class="p">,</span> <span class="n">logfile_name</span><span class="p">)</span>

        <span class="n">log_cfg_dic</span> <span class="o">=</span> <span class="n">arologcfg</span><span class="o">.</span><span class="n">log_config_dict</span>
        <span class="n">fmt_dic</span> <span class="o">=</span> <span class="n">log_cfg_dic</span><span class="p">[</span><span class="s2">&quot;formatters&quot;</span><span class="p">][</span><span class="s2">&quot;fmtgzyx_nocolor&quot;</span><span class="p">]</span>

        <span class="n">logfile_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile_path</span><span class="p">)</span>

        <span class="n">fileformatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="o">**</span><span class="n">fmt_dic</span><span class="p">)</span>

        <span class="n">logfile_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fileformatter</span><span class="p">)</span>
        <span class="n">logfile_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

        <span class="c1"># the root logger</span>
        <span class="c1"># https://stackoverflow.com/questions/48712206/what-is-the-name-of-pythons-root-logger</span>
        <span class="c1"># the heritage for loggers</span>
        <span class="c1"># https://stackoverflow.com/questions/29069655/python-logging-with-a-common-logger-class-mixin-and-class-inheritance</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logfile_handler</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logfile_handler</span></div>


<div class="viewcode-block" id="StepGnss.close_logfile">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.close_logfile">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">close_logfile</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        close the file handler of the logger</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">):</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.set_table_log">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.set_table_log">[docs]</a>
    <span class="k">def</span> <span class="nf">set_table_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>
        <span class="n">talo_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">ts</span><span class="p">,</span> <span class="n">step_suffix</span><span class="p">,</span> <span class="s2">&quot;table.log&quot;</span><span class="p">))</span>
        <span class="n">talo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">talo_name</span><span class="p">)</span>

        <span class="c1"># initalize with a void table</span>
        <span class="n">talo_df_void</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">talo_df_void</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">talo_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># if self.table_log_path:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_log_path</span> <span class="o">=</span> <span class="n">talo_path</span>

        <span class="k">return</span> <span class="n">talo_path</span></div>


<div class="viewcode-block" id="StepGnss.write_in_table_log">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.write_in_table_log">[docs]</a>
    <span class="k">def</span> <span class="nf">write_in_table_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_in</span><span class="p">):</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">row_in</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_log_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1">#  _______    _     _                                                                    _</span>
    <span class="c1"># |__   __|  | |   | |                                                                  | |</span>
    <span class="c1">#    | | __ _| |__ | | ___   _ __ ___   __ _ _ __   __ _  __ _  ___ _ __ ___   ___ _ __ | |_</span>
    <span class="c1">#    | |/ _` | &#39;_ \| |/ _ \ | &#39;_ ` _ \ / _` | &#39;_ \ / _` |/ _` |/ _ \ &#39;_ ` _ \ / _ \ &#39;_ \| __|</span>
    <span class="c1">#    | | (_| | |_) | |  __/ | | | | | | (_| | | | | (_| | (_| |  __/ | | | | |  __/ | | | |_</span>
    <span class="c1">#    |_|\__,_|_.__/|_|\___| |_| |_| |_|\__,_|_| |_|\__,_|\__, |\___|_| |_| |_|\___|_| |_|\__|</span>
    <span class="c1">#                                                         __/ |</span>
    <span class="c1">#                                                        |___/</span>

<div class="viewcode-block" id="StepGnss.print_table">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.print_table">[docs]</a>
    <span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_print</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">no_return</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_colwidth</span><span class="o">=</span><span class="mi">33</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the table of the StepGnss object with specified formatting.</span>

<span class="sd">        This method formats and prints the table of the StepGnss object. It shrinks the strings in the &#39;fraw&#39;,</span>
<span class="sd">        &#39;fpath_inp&#39;, and &#39;fpath_out&#39; columns to a specified maximum length and formats the &#39;epoch_srt&#39; and &#39;epoch_end&#39;</span>
<span class="sd">        columns as strings</span>
<span class="sd">        with a specific date-time format. The method then prints the formatted table to the logger.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        no_print : bool, optional</span>
<span class="sd">            If True, the function does not print the table to the logger. Default is False.</span>
<span class="sd">        no_return : bool, optional</span>
<span class="sd">            If True, the function does not return the formatted table. Default is True.</span>
<span class="sd">        max_colwidth : int, optional</span>
<span class="sd">            The maximum length of the strings in the &#39;fraw&#39;, &#39;fpath_inp&#39;, and &#39;fpath_out&#39; columns. Default is 33.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The formatted table as a string if &#39;no_return&#39; is False. Otherwise, None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">str_out</span> <span class="o">=</span> <span class="n">print_tbl_core</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
            <span class="n">no_print</span><span class="o">=</span><span class="n">no_print</span><span class="p">,</span>
            <span class="n">no_return</span><span class="o">=</span><span class="n">no_return</span><span class="p">,</span>
            <span class="n">max_colwidth</span><span class="o">=</span><span class="n">max_colwidth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_print</span><span class="p">:</span>
            <span class="c1"># print it in the logger (if silent , just return it)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_step_type</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="p">,</span> <span class="n">str_out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">str_out</span></div>


<div class="viewcode-block" id="StepGnss.table_ok_cols_bool">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.table_ok_cols_bool">[docs]</a>
    <span class="k">def</span> <span class="nf">table_ok_cols_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts the column of the table to boolean values.</span>

<span class="sd">        This method converts the specified column of the table to boolean values.</span>
<span class="sd">        The column is converted to True if the value is &#39;OK&#39; and False otherwise.</span>

<span class="sd">        Wrapper for arocmn.is_ok()</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arocmn</span><span class="o">.</span><span class="n">is_ok</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arocmn</span><span class="o">.</span><span class="n">is_ok</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.load_tab_datelist">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.load_tab_datelist">[docs]</a>
    <span class="k">def</span> <span class="nf">load_tab_datelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dates_list</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the table from a list of dates.</span>

<span class="sd">        This method takes a list of dates and uses it to update the current step&#39;s table.</span>
<span class="sd">        It sets the &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns of the table based on the dates in the list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dates_list : list</span>
<span class="sd">            The list of dates to be loaded into the table.</span>

<span class="sd">        period : str, optional</span>
<span class="sd">            The period between &quot;epoch_srt&quot; and &quot;epoch_end&quot;.</span>
<span class="sd">             Default is &quot;1D&quot; which means 1 day.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dates_list</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updt_epotab_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updt_eporng_tab</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.load_tab_filelist">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.load_tab_filelist">[docs]</a>
    <span class="k">def</span> <span class="nf">load_tab_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_files</span><span class="p">,</span> <span class="n">reset_table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the table from a list of input files.</span>

<span class="sd">        This method takes a list of input files and uses it to update the current step&#39;s table.</span>
<span class="sd">        It sets the &#39;fpath_inp&#39;, &#39;fname&#39;, and &#39;ok_inp&#39; columns of the table based on the input files.</span>
<span class="sd">        If &#39;reset_table&#39; is True, it resets the current table before loading the new data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input_files : list</span>
<span class="sd">            The list of input files to be loaded into the table.</span>
<span class="sd">            The input can be:</span>
<span class="sd">            * a python list</span>
<span class="sd">            * a text file path containing a list of files</span>
<span class="sd">            * a tuple containing several text files path</span>
<span class="sd">            * a directory path.</span>
<span class="sd">        reset_table : bool, optional</span>
<span class="sd">            If True, the current table is reset before loading the new data. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of input files that were loaded into the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">(</span><span class="n">init_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">inp_file_regex_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp_file_regex</span><span class="p">)</span>
        <span class="n">flist</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">import_files</span><span class="p">(</span><span class="n">input_files</span><span class="p">,</span> <span class="n">inp_file_regex_use</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">flist</span></div>


<div class="viewcode-block" id="StepGnss.load_tab_prev_tab">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.load_tab_prev_tab">[docs]</a>
    <span class="k">def</span> <span class="nf">load_tab_prev_tab</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prev_table</span><span class="p">,</span> <span class="n">reset_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_inp_is_prev</span><span class="o">=</span><span class="s2">&quot;out&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the table from the previous step&#39;s table.</span>

<span class="sd">        This method takes the table from the previous step in the processing chain and uses it to update the current</span>
<span class="sd">        step&#39;s table.</span>
<span class="sd">        It copies the &#39;fpath_out&#39;, &#39;size_out&#39;, &#39;fname&#39;, &#39;site&#39;, &#39;epoch_srt&#39;, &#39;epoch_end&#39;, and &#39;ok_inp&#39;</span>
<span class="sd">        columns from the input table to the current table.</span>
<span class="sd">        If &#39;reset_table&#39; is True, it resets the current table before loading the new data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prev_table : pandas.DataFrame</span>
<span class="sd">            The table from the previous step in the processing chain. It should contain &#39;fpath_out&#39;, &#39;size_out&#39;,</span>
<span class="sd">            &#39;fname&#39;, &#39;site&#39;, &#39;epoch_srt&#39;, &#39;epoch_end&#39;, and &#39;ok_inp&#39; columns.</span>
<span class="sd">        reset_table : bool, optional</span>
<span class="sd">            If True, the current table is reset before loading the new data. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">(</span><span class="n">init_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">prev_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drop_na</span><span class="p">:</span>
            <span class="n">prev_table</span> <span class="o">=</span> <span class="n">prev_table</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">,</span> <span class="s2">&quot;size_out&quot;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">prev_table</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_inp_is_prev</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;size_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="n">new_inp_is_prev</span> <span class="o">==</span> <span class="s2">&quot;inp&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;size_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;new_inp_is_prev must be &#39;out&#39; or &#39;inp&#39;&quot;</span><span class="p">)</span>

        <span class="n">isfile_lbd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">basnam_lbd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;none&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">isfile_lbd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">basnam_lbd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># epoch_srt and epoch_end are supposed to be timezone aware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.load_tab_inpdir">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.load_tab_inpdir">[docs]</a>
    <span class="k">def</span> <span class="nf">load_tab_inpdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset_table</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_epochs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the table with input files from the input directory for each epoch.</span>

<span class="sd">        This method iterates over the epochs in the epoch range, translates the input directory path for each epoch,</span>
<span class="sd">        and retrieves the list of input files. It then updates the table with the file paths, epochs, and other relevant</span>
<span class="sd">        information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reset_table : bool, optional</span>
<span class="sd">            If True, the current table is reset before loading the new data. Default is True.</span>
<span class="sd">        update_epochs : bool, optional</span>
<span class="sd">            If True, updates the &#39;epoch_srt&#39; and &#39;epoch_end&#39; columns of the table based on the RINEX files.</span>
<span class="sd">            Recommended for RINEX only.</span>
<span class="sd">            Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">reset_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_table</span><span class="p">(</span><span class="n">init_epoch</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">flist_all</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epolist_all</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">eporng_list</span><span class="p">():</span>
            <span class="n">inp_dir_epo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inp_dir</span><span class="p">,</span> <span class="n">epoch_inp</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">inp_file_regex_epo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inp_file_regex</span><span class="p">,</span> <span class="n">epoch_inp</span><span class="o">=</span><span class="n">epoch</span>
            <span class="p">)</span>
            <span class="n">flist_epo</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">import_files</span><span class="p">(</span><span class="n">inp_dir_epo</span><span class="p">,</span> <span class="n">inp_regex</span><span class="o">=</span><span class="n">inp_file_regex_epo</span><span class="p">)</span>
            <span class="n">n_files_epo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">flist_epo</span><span class="p">))</span>
            <span class="n">flist_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flist_epo</span><span class="p">)</span>
            <span class="n">epolist_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">epoch</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_files_epo</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> files found in </span><span class="si">%s</span><span class="s2">, regex: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">n_files_epo</span><span class="p">,</span>
                <span class="n">inp_dir_epo</span><span class="p">,</span>
                <span class="n">inp_file_regex_epo</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flist_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;site&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id</span>

        <span class="k">if</span> <span class="n">update_epochs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updt_epotab_rnx</span><span class="p">(</span><span class="n">use_rnx_filename_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epolist_all</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">epolist_all</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">period</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updt_epotab_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch_range</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.force">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.force">[docs]</a>
    <span class="k">def</span> <span class="nf">force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables the force mode for the current step.</span>

<span class="sd">        This method sets the &#39;ok_inp&#39; column of the table to True and updates the &#39;note&#39; column</span>
<span class="sd">        to indicate that the force mode is enabled for the specified step.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        step_name : str, optional</span>
<span class="sd">            The name of the step for which the force mode is enabled. Default is an empty string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;force </span><span class="si">%s</span><span class="s2"> is enabled&quot;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;note&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;force_&quot;</span> <span class="o">+</span> <span class="n">step_name</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="StepGnss.guess_local_rnx">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.guess_local_rnx">[docs]</a>
    <span class="k">def</span> <span class="nf">guess_local_rnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a given site name and date in a table, guess the potential local RINEX files</span>
<span class="sd">        and write it as &#39;fpath_out&#39; value in the table</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">loc_paths_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">warnmsg</span> <span class="o">=</span> <span class="s2">&quot;unable to get the epochs to generate local RINEX paths&quot;</span>
        <span class="c1">### no epoch at all, you are surely in convert mode</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">warnmsg</span><span class="si">}</span><span class="s2"> (normal in epoch-blind convert mode)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1">### some epochs are here, this is weirder and should not happen, we raise a warning</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;epoch_srt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">warnmsg</span><span class="si">}</span><span class="s2"> (something went wrong)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">loc_paths_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">loc_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_guess_rnx</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="n">io</span><span class="p">)</span>
            <span class="n">loc_paths_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc_path</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;nbr local RINEX files guessed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">loc_paths_list</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">loc_paths_list</span></div>


<div class="viewcode-block" id="StepGnss.guess_out_files">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.guess_out_files">[docs]</a>
    <span class="k">def</span> <span class="nf">guess_out_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates output file paths for each row in the table and updates the table.</span>

<span class="sd">        This method iterates over the rows of the table, constructs the output file path</span>
<span class="sd">        for each input file, and updates the `fpath_out` column in the table. It also</span>
<span class="sd">        ensures that the output directory exists and checks the validity of the output files.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of output file paths generated for the table rows.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The output directory is created if it does not exist.</span>
<span class="sd">        - The `check_local_files` method is called to validate the output files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_paths_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># Translate the output directory path for the current row and create it if necessary</span>
            <span class="n">outdir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path_row</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">irow</span><span class="o">=</span><span class="n">irow</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Construct the output file path using the input file&#39;s base name</span>
            <span class="n">bnam_inp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">])</span>
            <span class="n">fpath_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir_use</span><span class="p">,</span> <span class="n">bnam_inp</span><span class="p">)</span>

            <span class="c1"># Update the table with the generated output file path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpath_out</span>

            <span class="c1"># Check the validity of the output files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_local_files</span><span class="p">(</span><span class="n">io</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">)</span>

            <span class="c1"># Append the output file path to the list</span>
            <span class="n">out_paths_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpath_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out_paths_list</span></div>


<div class="viewcode-block" id="StepGnss.check_local_files">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.check_local_files">[docs]</a>
    <span class="k">def</span> <span class="nf">check_local_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the existence of the output (&#39;out&#39;) or input (&#39;inp&#39;) local files (for non download cases)</span>
<span class="sd">        and updates the corresponding booleans in the &#39;ok_out&#39; or &#39;ok_inp&#39; column of the table.</span>

<span class="sd">        This method iterates over each row in the table. For each row,</span>
<span class="sd">        it checks if the local file specified in</span>
<span class="sd">        the &#39;fpath_out&#39; entry exists and is not empty.</span>
<span class="sd">        If the file exists and is not empty,</span>
<span class="sd">        the method sets the &#39;ok_out&#39; entry for the file in the table to True</span>
<span class="sd">        and updates the &#39;size_out&#39; entry with the size of the file.</span>
<span class="sd">        If the file does not exist or is empty, the method sets</span>
<span class="sd">        the &#39;ok_out&#39; entry for the file in the table to False.</span>

<span class="sd">        The method returns a list of the paths of the existing and non-empty local files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        io : str, optional</span>
<span class="sd">            The input/output direction to check. Default is &#39;out&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of paths of the existing and non-empty local files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">local_files_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">io</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;io must be &#39;inp&#39; or &#39;out&#39;&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">loc_file_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_chk_local</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="n">io</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc_file_out</span><span class="p">:</span>
                <span class="n">local_files_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc_file_out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">local_files_list</span></div>


<div class="viewcode-block" id="StepGnss.invalidate_small_local_files">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.invalidate_small_local_files">[docs]</a>
    <span class="k">def</span> <span class="nf">invalidate_small_local_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> <span class="n">abs_min</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invalidates local files that are smaller than a certain threshold.</span>

<span class="sd">        This method checks if the size of each local file is smaller than the threshold times</span>
<span class="sd">        the median size of all local files.</span>
<span class="sd">        If a file is smaller, the method sets the &#39;ok_out&#39; entry for the file in the table to False,</span>
<span class="sd">        indicating that the file is invalid and needs to be redownloaded.</span>
<span class="sd">        The method returns a list of the paths of the invalidated files.</span>

<span class="sd">        Note: The &#39;check_local_files&#39; method must be called before this method to ensure that</span>
<span class="sd">        the &#39;size_out&#39; and &#39;ok_out&#39; entries in the table are up-to-date.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            The threshold for the file size, as a fraction of the median file size. Default is 0.80.</span>
<span class="sd">        abs_min : int, optional</span>
<span class="sd">           The absolute minimum file size in bytes. Default is 1000 bytes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of paths of the invalidated files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c1"># +++ test 1: above the median</span>
            <span class="n">med</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">valid_bool1</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">med</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_out&quot;</span><span class="p">]</span>
            <span class="c1"># +++ test 2: above an absolute minimum</span>
            <span class="n">valid_bool2</span> <span class="o">=</span> <span class="n">abs_min</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;size_out&quot;</span><span class="p">]</span>
            <span class="c1"># +++ test 3: both tests</span>
            <span class="n">valid_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">valid_bool1</span><span class="p">,</span> <span class="n">valid_bool2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_bool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">valid_bool1</span><span class="p">),</span> <span class="s2">&quot;note&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;invalid_med&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">valid_bool2</span><span class="p">),</span> <span class="s2">&quot;note&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;invalid_abs&quot;</span>

            <span class="n">invalid_local_files_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">valid_bool</span><span class="p">,</span> <span class="s2">&quot;fpath_out&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invalid_local_files_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">invalid_local_files_list</span></div>


<div class="viewcode-block" id="StepGnss.decompress">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.decompress">[docs]</a>
    <span class="k">def</span> <span class="nf">decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">,</span> <span class="n">table_ok_col</span><span class="o">=</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        decompress the potential compressed files in the ``table_col`` column</span>
<span class="sd">        and its corresponding ``table_ok_col`` boolean column</span>
<span class="sd">        (usually ``fpath_inp`` and ``ok_inp``)</span>

<span class="sd">        It will uncompress the file if it is a</span>
<span class="sd">        (gzip+)Hatanaka-compressed RINEX, or a generic-compressed file</span>
<span class="sd">        (gzip only for the moment)</span>

<span class="sd">        It will create a new column ``fpath_ori`` (for original)</span>
<span class="sd">        to keep the trace of the original file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        files_decmp_list</span>
<span class="sd">            the DEcompressed files i.e. the one which are temporary and must be removed</span>
<span class="sd">        files_uncmp_list</span>
<span class="sd">            the UNcompressed files i.e. ALL the usables ones</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files_decmp_list</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[]</span>
        <span class="p">)</span>  <span class="c1">#### the DEcompressed files i.e. the one which are temporary and must be removed</span>
        <span class="n">files_uncmp_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#### the UNcompressed files i.e. ALL the usables ones</span>

        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">file_decmp</span><span class="p">,</span> <span class="n">bool_decmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_decompress</span><span class="p">(</span>
                <span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="n">table_col</span><span class="p">,</span> <span class="n">table_ok_col</span><span class="o">=</span><span class="n">table_ok_col</span>
            <span class="p">)</span>

            <span class="n">files_uncmp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_decmp</span><span class="p">)</span>  <span class="c1">### all files are stored in this list</span>
            <span class="k">if</span> <span class="n">bool_decmp</span><span class="p">:</span>
                <span class="n">files_decmp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_decmp</span><span class="p">)</span>
                <span class="c1">### only the DEcompressed files are stored in this list (to be rm later)</span>

        <span class="k">return</span> <span class="n">files_decmp_list</span><span class="p">,</span> <span class="n">files_uncmp_list</span></div>


<div class="viewcode-block" id="StepGnss.decompress_table_batch">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.decompress_table_batch">[docs]</a>
    <span class="k">def</span> <span class="nf">decompress_table_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">,</span> <span class="n">table_ok_col</span><span class="o">=</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decompresses the potential compressed files in the specified column of the table.</span>

<span class="sd">        This method checks if the files specified in the &#39;table_col&#39; column of the table are compressed.</span>
<span class="sd">        If they are, the method decompresses the files and updates the &#39;table_col&#39; column with the paths of</span>
<span class="sd">        the decompressed files.</span>
<span class="sd">        It also updates the &#39;ok_inp&#39; column with the existence of the decompressed files and the &#39;fname&#39;</span>
<span class="sd">        column with the basenames of the decompressed files.</span>
<span class="sd">        If the files are not compressed or the &#39;ok_inp&#39; column is False, the method does nothing.</span>
<span class="sd">        The method processes a complete table at once, which is faster than row-iterative decompression done by</span>
<span class="sd">        `decompress`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table_col : str, optional</span>
<span class="sd">            The column in the table where the paths of the files are stored. Default is &#39;fpath_inp&#39;.</span>
<span class="sd">        table_ok_col : str, optional</span>
<span class="sd">            The column in the table where the boolean indicating the existence of the files is stored.</span>
<span class="sd">            Default is &#39;ok_inp&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of paths of the decompressed files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bool_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">table_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">arocmn</span><span class="o">.</span><span class="n">is_compressed</span><span class="p">)</span>
        <span class="n">bool_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">table_ok_col</span><span class="p">]</span>
        <span class="n">bool_wrk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bool_comp</span><span class="p">,</span> <span class="n">bool_ok</span><span class="p">)</span>
        <span class="n">idx_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bool_wrk</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="s2">&quot;fpath_ori&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tmp_dir_unzipped&quot;</span><span class="p">):</span>
            <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span>
        <span class="n">files_decmp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">arocmn</span><span class="o">.</span><span class="n">decompress_file</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">files_decmp_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx_comp</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">files_decmp_list</span></div>


<div class="viewcode-block" id="StepGnss.move_files">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.move_files">[docs]</a>
    <span class="k">def</span> <span class="nf">move_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;inpout&quot;</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves or copies files based on the specified mode.</span>

<span class="sd">        This method iterates over the rows in the table and moves or copies files</span>
<span class="sd">        from the input path to the output path or to the final destination based on the mode.</span>
<span class="sd">        It validates the move or copy operation and updates the table accordingly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str, optional</span>
<span class="sd">            The mode of operation. Can be:</span>
<span class="sd">            &#39;inpout&#39; to move/copy files from input to output path,</span>
<span class="sd">            &#39;final&#39; to move/copy files to the final destination.</span>
<span class="sd">            Default is &#39;inpout&#39;.</span>
<span class="sd">        copy_only : bool, optional</span>
<span class="sd">            If True, the files are copied instead of moved. Default is False.</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            If True, forces the operation even if the input files are not valid. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of paths of the moved or copied files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mvcp</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">copy_only</span> <span class="k">else</span> <span class="s2">&quot;move&quot;</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span><span class="p">(</span><span class="n">mvcp</span><span class="p">)</span>

        <span class="n">file_mv_lis</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;inpout&quot;</span><span class="p">:</span>
                <span class="n">file_mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_mv_inpout</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="n">copy_only</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">:</span>
                <span class="n">file_mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_mv_final</span><span class="p">(</span>
                    <span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="n">copy_only</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;inpout&#39; or &#39;final&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

            <span class="n">file_mv_lis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_mv</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">file_mv_lis</span></div>


<div class="viewcode-block" id="StepGnss.remov_tmp_files">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.remov_tmp_files">[docs]</a>
    <span class="k">def</span> <span class="nf">remov_tmp_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the temporary files which have been stored in the two lists</span>
<span class="sd">        self.tmp_rnx_files and self.tmp_decmp_files.</span>

<span class="sd">        This method iterates over the lists of temporary RINEX and decompressed files.</span>
<span class="sd">        If a file exists and is not an original file, it is removed and its path is removed from the list.</span>
<span class="sd">        If a file does not exist or is an original file, its path is kept in the list for future reference.</span>

<span class="sd">        Note: This method modifies the &#39;tmp_rnx_files&#39; and &#39;tmp_decmp_files&#39; attributes of the object.</span>

<span class="sd">        See Also clean_tmp_dirs(), which clean all the temporary files based on their creation date</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TEMP RINEX Files</span>
        <span class="n">tmp_rnx_files_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_rnx_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;remove tmp converted RINEX file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp_rnx_files_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_rnx_files</span> <span class="o">=</span> <span class="n">tmp_rnx_files_new</span>

        <span class="c1"># TEMP decompressed Files</span>
        <span class="n">tmp_decmp_files_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_decmp_files</span><span class="p">:</span>
            <span class="c1"># we also test if the file is not an original one!</span>
            <span class="k">if</span> <span class="s2">&quot;fpath_ori&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;file has been uncompressed, but no &#39;fpath_ori&#39; field in table, we keep it for security: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">f</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tmp_decmp_files_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">is_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_ori&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">f</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_original</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;uncompressed file is also an original one, we keep it for security: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">f</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">tmp_decmp_files_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_original</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;remove tmp decompress RINEX file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_decmp_files</span> <span class="o">=</span> <span class="n">tmp_decmp_files_new</span></div>


    <span class="c1">#  ______ _ _ _              _        _     _</span>
    <span class="c1"># |  ____(_) | |            | |      | |   | |</span>
    <span class="c1"># | |__   _| | |_ ___ _ __  | |_ __ _| |__ | | ___</span>
    <span class="c1"># |  __| | | | __/ _ \ &#39;__| | __/ _` | &#39;_ \| |/ _ \</span>
    <span class="c1"># | |    | | | ||  __/ |    | || (_| | |_) | |  __/</span>
    <span class="c1"># |_|    |_|_|\__\___|_|     \__\__,_|_.__/|_|\___|</span>

<div class="viewcode-block" id="StepGnss.filter_bad_keywords">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_bad_keywords">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_bad_keywords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keywords_path_excl</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters a list of raw files if the full path contains certain keywords.</span>

<span class="sd">        This method checks if the full path of the raw files contains any of the provided keywords.</span>
<span class="sd">        If a keyword is found in the full path of a raw file, the file is filtered out.</span>
<span class="sd">        The method modifies the &#39;ok_inp&#39; column of the object&#39;s table to reflect the filtering.</span>
<span class="sd">        The method returns a list of filtered raw files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        keywords_path_excl : list</span>
<span class="sd">            The list of keywords to filter the raw files.</span>
<span class="sd">            For example, if keywords_path_excl is [&#39;badword1&#39;, &#39;badword2&#39;],</span>
<span class="sd">            any file whose full path contains either &#39;badword1&#39; or &#39;badword2&#39; will be filtered out.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of filtered raw files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ok_inp_bool_stk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nfil</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;fname&quot;</span><span class="p">]</span>
            <span class="n">boolbad</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">patterns_in_string_checker</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">keywords_path_excl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">boolbad</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file filtered, contains an excluded keyword: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">nfil</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">ok_inp</span><span class="p">:</span>  <span class="c1"># ok_inp is already false</span>
                    <span class="n">ok_inp_bool_stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ok_inp_bool_stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">flist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># final replace of ok init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok_inp_bool_stk</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6i</span><span class="s2"> files filtered, their paths contain bad keywords&quot;</span><span class="p">,</span> <span class="n">nfil</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flist_out</span></div>


<div class="viewcode-block" id="StepGnss.filter_year_min_max">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_year_min_max">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_year_min_max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year_min</span><span class="o">=</span><span class="mi">1980</span><span class="p">,</span> <span class="n">year_max</span><span class="o">=</span><span class="mi">2099</span><span class="p">,</span> <span class="n">year_in_inp_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters a list of raw files based on their year range.</span>

<span class="sd">        This method checks if the year in the file path is within a specified range.</span>
<span class="sd">        The year is determined either by its position in the absolute path (if provided) or by a regex search.</span>
<span class="sd">        The method modifies the &#39;ok_inp&#39; column of the object&#39;s table to reflect the filtering.</span>
<span class="sd">        The method returns a list of filtered raw files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        year_min : int, optional</span>
<span class="sd">            The minimum year for the range. Default is 1980.</span>
<span class="sd">        year_max : int, optional</span>
<span class="sd">            The maximum year for the range. Default is 2099.</span>
<span class="sd">        year_in_inp_path : int, optional</span>
<span class="sd">            The position of the year in the absolute path. If not provided, a regex search is performed.</span>
<span class="sd">            For example, if the absolute path is:</span>
<span class="sd">            /home/user/input_data/raw/2011/176/PSA1201106250000a.T00</span>
<span class="sd">            year_in_inp_path is 4</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of filtered raw files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_year_detect</span><span class="p">(</span><span class="n">fpath_inp</span><span class="p">,</span> <span class="n">year_in_inp_path0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Detects the year in the file path.</span>

<span class="sd">            This function checks if a year_in_inp_path is provided.</span>
<span class="sd">            If it is, it gets the year from the specified position in the file path.</span>
<span class="sd">            If a year_in_inp_path is not provided, it performs a regex search to find the year.</span>
<span class="sd">            If the year cannot be found, it logs a warning and returns NaN.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            fpath_inp : str</span>
<span class="sd">                The input file path.</span>
<span class="sd">            year_in_inp_path0 : int, optional</span>
<span class="sd">                The position of the year in the absolute path.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            int or NaN</span>
<span class="sd">                The detected year or NaN if the year cannot be found.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">year_in_inp_path0</span><span class="p">:</span>
                    <span class="n">year_folder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fpath_inp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="n">year_in_inp_path0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rgx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/(19|20)[0-9]</span><span class="si">{2}</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="n">fpath_inp</span><span class="p">)</span>
                    <span class="n">year_folder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rgx</span><span class="o">.</span><span class="n">group</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">year_folder</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unable to get the year in path: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fpath_inp</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">years</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fraw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_year_detect</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">year_in_inp_path</span><span class="p">,))</span>

        <span class="n">bool_out_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">years</span> <span class="o">&lt;</span> <span class="n">year_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">years</span> <span class="o">&gt;</span> <span class="n">year_max</span><span class="p">)</span>
        <span class="n">bool_in_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">bool_out_range</span><span class="p">)</span>

        <span class="n">ok_inp_bool_stk</span> <span class="o">=</span> <span class="n">bool_in_range</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span>
        <span class="n">nfil_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bool_out_range</span><span class="p">)</span>
        <span class="n">nfil_spec</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bool_out_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok_inp_bool_stk</span>

        <span class="n">flist_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">],</span> <span class="s2">&quot;fraw&quot;</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%6i</span><span class="s2">/</span><span class="si">%6i</span><span class="s2"> files filtered (total/specific) not in the year min/max range (</span><span class="si">%4i</span><span class="s2">/</span><span class="si">%4i</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">nfil_total</span><span class="p">,</span>
            <span class="n">nfil_spec</span><span class="p">,</span>
            <span class="n">year_min</span><span class="p">,</span>
            <span class="n">year_max</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">flist_out</span></div>


<div class="viewcode-block" id="StepGnss.filter_filelist">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_filelist">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filelist_exclu_inp</span><span class="p">,</span> <span class="n">message_manu_exclu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters a list of raw files based on their presence in a provided exclusion list.</span>

<span class="sd">        This method checks if the raw files are present in the provided exclusion list.</span>
<span class="sd">        If a raw file is present in the exclusion list, it is filtered out.</span>
<span class="sd">        The method modifies the &#39;ok_inp&#39; column of the object&#39;s table to reflect the filtering.</span>
<span class="sd">        The method returns a list of filtered raw files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filelist_exclu_inp : str or list</span>
<span class="sd">            The exclusion list. It can be a string representing a path to a text file containing the exclusion list,</span>
<span class="sd">            or a list of strings representing the exclusion list.</span>
<span class="sd">        message_manu_exclu : bool, optional</span>
<span class="sd">            If True, a debug message is logged for each file that is manually filtered in the exclusion list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of filtered raw files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flist_exclu</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">import_files</span><span class="p">(</span><span class="n">filelist_exclu_inp</span><span class="p">)</span>

        <span class="n">flist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ok_inp_bool_stk</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">nfil</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">irow</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">fraw</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist_exclu</span><span class="p">:</span>
                <span class="n">nfil</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ok_inp_bool_stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">message_manu_exclu</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;file filtered, was OK during a previous run (legacy simple list): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">f</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;file filtered manually in the exclusion list: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">ok_inp</span><span class="p">:</span>  <span class="c1"># ok_inp is already false</span>
                    <span class="n">ok_inp_bool_stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ok_inp_bool_stk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">flist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_manu_exclu</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%6i</span><span class="s2"> files filtered, were OK during a previous run (legacy simple OK list)&quot;</span><span class="p">,</span>
                <span class="n">nfil</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%6i</span><span class="s2"> files manually filtered in the exclusion list,&quot;</span><span class="p">,</span> <span class="n">nfil</span><span class="p">)</span>

        <span class="c1"># final replace of ok init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok_inp_bool_stk</span>

        <span class="k">return</span> <span class="n">flist_out</span></div>


<div class="viewcode-block" id="StepGnss.filter_ok_out">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_ok_out">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_ok_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the raw files based on the &#39;ok_out&#39; boolean column of the object&#39;s table.</span>

<span class="sd">        This method checks if the raw files have a positive &#39;ok_out&#39; boolean</span>
<span class="sd">        i.e., the converted file already exists.</span>
<span class="sd">        It modifies the &#39;ok_inp&#39; boolean column of the object&#39;s table</span>
<span class="sd">        i.e. the step action must be done (True) or not (False)</span>
<span class="sd">        and returns the filtered raw files in a list.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of filtered raw files.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_not_impl</span><span class="p">(</span><span class="n">ok_inp</span><span class="p">,</span> <span class="n">ok_out</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Implements the negation of an implication logic operation.</span>

<span class="sd">            This function takes two boolean inputs and returns the result of the operation</span>
<span class="sd">            &quot;NOT(ok_inp =&gt; ok_out)&quot; i.e. &quot;ok_inp AND NOT(ok_out)&quot;.</span>
<span class="sd">            This operation is equivalent to the negation of an implication,</span>
<span class="sd">            as shown in the truth table below:</span>

<span class="sd">            ok_inp ok_out result</span>
<span class="sd">            0      0      0</span>
<span class="sd">            1      0      1</span>
<span class="sd">            0      1      0</span>
<span class="sd">            1      1      0</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            ok_inp : bool</span>
<span class="sd">                The first boolean input to the logic operation.</span>
<span class="sd">            ok_out : bool</span>
<span class="sd">                The second boolean input to the logic operation.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            bool</span>
<span class="sd">                The result of the logic operation &quot;ok_inp AND NOT(ok_out)&quot;.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ok_inp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ok_out</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">ok_inp_new</span> <span class="o">=</span> <span class="n">_not_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">flist_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">][</span><span class="n">ok_inp_new</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok_inp_new</span>

        <span class="k">return</span> <span class="n">flist_out</span></div>


<div class="viewcode-block" id="StepGnss.filter_prev_tab">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_prev_tab">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_prev_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_prev_tab</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the raw files based on their presence in previous conversion tables.</span>

<span class="sd">        This method checks if the raw files are present in previous conversion tables that are stored as logs.</span>
<span class="sd">        If a raw file is present in the previous conversion tables, it is filtered out.</span>
<span class="sd">        The method modifies the &#39;ok_inp&#39; column of the object&#39;s table to reflect the filtering.</span>
<span class="sd">        The method returns a list of filtered raw files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df_prev_tab : pandas.DataFrame</span>
<span class="sd">            The previous conversion tables stored as a DataFrame.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            The list of filtered raw files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_ok_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span>

        <span class="c1"># previous files when everything was ok</span>
        <span class="n">prev_bool_ok</span> <span class="o">=</span> <span class="n">df_prev_tab</span><span class="p">[</span><span class="n">col_ok_names</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prev_files_ok</span> <span class="o">=</span> <span class="n">df_prev_tab</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev_bool_ok</span><span class="p">,</span> <span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span>

        <span class="c1"># current files which have been already OK and which have already</span>
        <span class="c1"># ok_inp == False</span>
        <span class="c1"># here the boolean value are inverted compared to the table:</span>
        <span class="c1"># True = skip me / False = keep me</span>
        <span class="c1"># a logical not inverts everything at the end</span>
        <span class="n">curr_files_ok_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">prev_files_ok</span><span class="p">)</span>
        <span class="n">curr_files_off_already</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">])</span>

        <span class="n">curr_files_skip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">curr_files_ok_prev</span><span class="p">,</span> <span class="n">curr_files_off_already</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">curr_files_skip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_files_ok_prev</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%6i</span><span class="s2"> files filtered, were OK during a previous run (table list)&quot;</span><span class="p">,</span>
            <span class="n">curr_files_ok_prev</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">flist_out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">],</span> <span class="s2">&quot;fpath_inp&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">flist_out</span></div>


<div class="viewcode-block" id="StepGnss.filter_purge">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_purge">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_purge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;ok_inp&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the table based on the values in a specified column.</span>

<span class="sd">        This method removes all rows in the table where</span>
<span class="sd">        the value in the specified column is False.</span>
<span class="sd">        The method can either return a new DataFrame with</span>
<span class="sd">        the filtered data or modify the existing DataFrame in place.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        col : str, optional</span>
<span class="sd">            The name of the column to use for filtering.</span>
<span class="sd">            The column should contain boolean values. Defaults to &#39;ok_inp&#39;.</span>
<span class="sd">        inplace : bool, optional</span>
<span class="sd">            If True, the method will modify the existing DataFrame in place.</span>
<span class="sd">            If False, the method will return a new</span>
<span class="sd">            DataFrame with the filtered data. Defaults to False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame or list</span>
<span class="sd">            If inplace is False, returns a new DataFrame with the filtered data.</span>
<span class="sd">            If inplace is True, returns a list of</span>
<span class="sd">            values in the specified column after filtering.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;the table is empty, unable to purge it&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
        <span class="k">elif</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="StepGnss.filter_na">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.filter_na">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_na</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filters the table to remove rows with NaN values in the specified columns,</span>
<span class="sd">        and prints the dropped rows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cols : list, optional</span>
<span class="sd">            The list of columns to check for NaN values.</span>
<span class="sd">            If None, all columns are checked.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            The dropped rows.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Identify rows to be dropped</span>
        <span class="n">isna_bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dropped_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">isna_bool</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dropped_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;row(s) filtered bc. NaN/NaT values in: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">arocmn</span><span class="o">.</span><span class="n">print_tbl_core</span><span class="p">(</span><span class="n">dropped_rows</span><span class="p">))</span>

        <span class="c1"># Return filtered table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="o">~</span><span class="n">isna_bool</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dropped_rows</span></div>


    <span class="c1">#               _   _                   _ _                           _ _    __                                 __</span>
    <span class="c1">#     /\       | | (_)                 ( | )                         ( | )  / /                                 \ \</span>
    <span class="c1">#    /  \   ___| |_ _  ___  _ __  ___   V V_ __ ___   ___  _ __   ___ V V  | | ___  _ __    _ __ _____      _____| |</span>
    <span class="c1">#   / /\ \ / __| __| |/ _ \| &#39;_ \/ __|    | &#39;_ ` _ \ / _ \| &#39;_ \ / _ \     | |/ _ \| &#39;_ \  | &#39;__/ _ \ \ /\ / / __| |</span>
    <span class="c1">#  / ____ \ (__| |_| | (_) | | | \__ \    | | | | | | (_) | | | | (_) |    | | (_) | | | | | | | (_) \ V  V /\__ \ |</span>
    <span class="c1"># /_/    \_\___|\__|_|\___/|_| |_|___/    |_| |_| |_|\___/|_| |_|\___/     | |\___/|_| |_| |_|  \___/ \_/\_/ |___/ |</span>
    <span class="c1">#                                                                           \_\                                 /_/</span>

<div class="viewcode-block" id="StepGnss.mono_ok_check">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_ok_check">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_ok_check</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">irow</span><span class="p">,</span>
        <span class="n">step_name</span><span class="p">,</span>
        <span class="n">fname_custom</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">switch_ok_out_false</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mv_final_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the status of the input and output files for a specific row in the table.</span>

<span class="sd">        This method verifies if the input file is valid and if the output file already exists.</span>
<span class="sd">        It logs appropriate messages and determines if the current step should be skipped.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table to check.</span>
<span class="sd">        step_name : str, optional</span>
<span class="sd">            The name of the step being checked. Default is &quot;splice&quot;.</span>
<span class="sd">        fname_custom : str, optional</span>
<span class="sd">            The custom filename to use for logging. If not provided, &quot;fpath_inp&quot; from the table is used.</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            If True, the step is forced and the input file is processed regardless of its status.</span>
<span class="sd">            Default is False.</span>
<span class="sd">            Usage of this option is discouraged, and kept manily for legacy reasons.</span>
<span class="sd">            It is better to set all the ok_inp boolean in the table to True with the .force() method.</span>
<span class="sd">        switch_ok_out_false : bool, optional</span>
<span class="sd">            If True, the &#39;ok_out&#39; column of the table is set to False if the step should be skipped.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        mv_final_mode : bool, optional</span>
<span class="sd">            If True, the step is skipped if the output file does not exists.</span>
<span class="sd">            Designed for final move (mv_final) steps.</span>
<span class="sd">            Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            False if the step should be skipped, True otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NB: we disable this option since it is not used (2025-01-14)</span>
        <span class="c1"># check_ok_out_only : bool, optional</span>
        <span class="c1">#     If True, the step is skipped if the output file already exists.</span>
        <span class="c1">#     (no check on the ok_inp column)</span>
        <span class="c1">#     Default is False.</span>
        <span class="c1">#</span>
        <span class="c1"># This approach is risky =&gt;</span>
        <span class="c1"># ok_inp should be set to False before using self.filter_ok_out(),</span>
        <span class="c1"># rather than this check focusing solely on ok_out.</span>

        <span class="k">if</span> <span class="n">fname_custom</span><span class="p">:</span>
            <span class="n">finp_use</span> <span class="o">=</span> <span class="n">fname_custom</span>
            <span class="n">fout_use</span> <span class="o">=</span> <span class="n">fname_custom</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finp_use</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_inp&quot;</span><span class="p">]))</span>
            <span class="n">fout_use</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_inp&quot;</span><span class="p">]))</span>

        <span class="c1">### stacklevel = 2</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> forced: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">finp_use</span><span class="p">)</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">mv_final_mode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]:</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">mv_final_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> skipped (output not found): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">fout_use</span><span class="p">)</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># NB: we disable this option since it is not used (2025-01-14)</span>
        <span class="c1"># elif check_ok_out_only and self.table.loc[irow, &quot;ok_out&quot;]:</span>
        <span class="c1">#     logger.info(&quot;%s skipped (output already exists): %s&quot;, step_name, fout_use)</span>
        <span class="c1">#     bool_ok = False</span>
        <span class="c1"># elif check_ok_out_only and not self.table.loc[irow, &quot;ok_out&quot;]:</span>
        <span class="c1">#     bool_ok = True</span>
        <span class="c1"># This approach is risky =&gt;</span>
        <span class="c1"># ok_inp should be set to False before using self.filter_ok_out(),</span>
        <span class="c1"># rather than this check focusing solely on ok_out.</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> skipped (output already exists): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">fout_use</span><span class="p">)</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> skipped (input disabled): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="n">finp_use</span><span class="p">)</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bool_ok</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bool_ok</span> <span class="ow">and</span> <span class="n">switch_ok_out_false</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">bool_ok</span></div>


<div class="viewcode-block" id="StepGnss.updt_rnxmodopts">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.updt_rnxmodopts">[docs]</a>
    <span class="k">def</span> <span class="nf">updt_rnxmodopts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rinexmod_options_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">irow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug_print</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the rinexmod options dictionnary.</span>

<span class="sd">        This method updates the rinexmod options based on the provided input options and the current</span>
<span class="sd">        state of the StepGnss object. It handles default options, merges them with input options, and sets</span>
<span class="sd">        specific options like metadata and site name/marker.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rinexmod_options_inp : dict, optional</span>
<span class="sd">            Input options for RINEX modification. Default is None.</span>
<span class="sd">        irow : int, optional</span>
<span class="sd">            Row index for setting the site name/marker from the table. Default is None.</span>
<span class="sd">        debug_print : bool, optional</span>
<span class="sd">            If True, prints the RINEX modification options for debugging purposes. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Updated RINEX modification options.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rinexmod_options_inp</span><span class="p">:</span>
            <span class="n">rinexmod_options_inp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># just a shorter alias</span>
        <span class="n">rimopts_inp</span> <span class="o">=</span> <span class="n">rinexmod_options_inp</span>

        <span class="c1"># default options/arguments for rinexmod</span>
        <span class="n">rimopts_def</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &#39;marker&#39;: &#39;XXXX&#39;, # forced below</span>
            <span class="c1"># &#39;sitelog&#39;: metadata, # forced below</span>
            <span class="s2">&quot;compression&quot;</span><span class="p">:</span> <span class="s2">&quot;gz&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;longname&quot;: True, # managed below</span>
            <span class="s2">&quot;force_rnx_load&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;verbose&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;filename_style&quot;</span><span class="p">:</span> <span class="s2">&quot;basic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;full_history&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># handle the specific case of a station.info input</span>
        <span class="c1"># necessary for users using the station.info input (like EK@ENS)</span>
        <span class="n">update_sitelog</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rimopts_inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sitelog&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rimopts_inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;station_info&quot;</span><span class="p">):</span>
            <span class="n">rimopts_def</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;sitelog&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">update_sitelog</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># create the working copy of the default options</span>
        <span class="n">rimopts_out</span> <span class="o">=</span> <span class="n">rimopts_def</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rimopts_wrk</span> <span class="o">=</span> <span class="n">rimopts_inp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># print the initial state</span>
        <span class="k">if</span> <span class="n">debug_print</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;default options for rinexmod: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rimopts_def</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;input options for rinexmod: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rimopts_inp</span><span class="p">)</span>

        <span class="c1"># +++ set #1: the metadata/sitelog</span>
        <span class="k">if</span> <span class="n">update_sitelog</span><span class="p">:</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;sitelog&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

        <span class="c1"># +++ set #2: site name/marker</span>
        <span class="k">if</span> <span class="s2">&quot;marker&quot;</span> <span class="ow">in</span> <span class="n">rimopts_inp</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rimopts_inp</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">irow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;site&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id9</span><span class="p">:</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_id9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;unable to set the marker (irow is </span><span class="si">%s</span><span class="s2">, self.site_id9 is </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">irow</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">site_id9</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># better give nothing rather than XXXX00XXX (nasty side effects)</span>
        <span class="k">if</span> <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;XXXX00XXX&quot;</span><span class="p">:</span>
            <span class="n">rimopts_wrk</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;marker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># +++ set #3: the short/longname</span>
        <span class="c1"># if not (&quot;shortname&quot; in rimopts_wrk.keys() and &quot;longname&quot; in rimopts_wrk.keys()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">rimopts_wrk</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;shortname&quot;</span><span class="p">,</span> <span class="s2">&quot;longname&quot;</span><span class="p">)):</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;shortname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">rimopts_wrk</span><span class="p">[</span><span class="s2">&quot;longname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># DO THE UPDATE HERE</span>
        <span class="n">rimopts_out</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rimopts_wrk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug_print</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;final options for rinexmod: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">rimopts_wrk</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rimopts_out</span></div>


<div class="viewcode-block" id="StepGnss.mono_rinexmod">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_rinexmod">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_rinexmod</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">,</span> <span class="n">rinexmod_options</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;on row&quot; method</span>

<span class="sd">        Applies the rinexmod function to the &#39;table_col&#39; entry of a specific row in the table.</span>

<span class="sd">        This method is applied on each row of the table. It checks if the &#39;ok_inp&#39; column is True for the row.</span>
<span class="sd">        If it is, it applies the rinexmod function to the file specified in the &#39;table_col&#39; column.</span>
<span class="sd">        The rinexmod function modifies the RINEX file according to the provided rinexmod_options.</span>
<span class="sd">        The modified file is then saved to the specified output directory.</span>
<span class="sd">        The method also updates the &#39;ok_out&#39;, &#39;table_col&#39;, and &#39;size_out&#39; columns of the table for the row based on the</span>
<span class="sd">        success of the operation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table on which the method is applied.</span>
<span class="sd">        out_dir : str, optional</span>
<span class="sd">            The directory to which the modified file is saved. If not provided, the &#39;tmp_dir_rinexmoded&#39; attribute of</span>
<span class="sd">            the object is used.</span>
<span class="sd">        table_col : str, optional</span>
<span class="sd">            The column in the table which contains the file path to be modified. Defaults to &#39;fpath_out&#39;.</span>
<span class="sd">        rinexmod_options : dict, optional</span>
<span class="sd">            The options to be used by the rinexmod function. If not provided, default options are used.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The path of the modified file if the operation is successful, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_ok_check</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;rinexmod&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># definition of the output directory (after the action)</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tmp_dir_rinexmoded&quot;</span><span class="p">):</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_rinexmoded</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span>

        <span class="n">rinexmod_options_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updt_rnxmodopts</span><span class="p">(</span><span class="n">rinexmod_options</span><span class="p">,</span> <span class="n">irow</span><span class="p">)</span>

        <span class="n">frnx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">frnxmod</span> <span class="o">=</span> <span class="n">rinexmod</span><span class="o">.</span><span class="n">rinexmod_api</span><span class="o">.</span><span class="n">rinexmod</span><span class="p">(</span>
                <span class="n">frnx</span><span class="p">,</span> <span class="n">out_dir_use</span><span class="p">,</span> <span class="o">**</span><span class="n">rinexmod_options_use</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frnx</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception raised: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">frnxmod</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">frnxmod</span><span class="p">:</span>
            <span class="c1">### update table if things go well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">frnxmod</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;size_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">frnxmod</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">epo_srt_ok</span><span class="p">,</span> <span class="n">epo_end_ok</span> <span class="o">=</span> <span class="n">rinexmod</span><span class="o">.</span><span class="n">rinexfile</span><span class="o">.</span><span class="n">dates_from_rinex_filename</span><span class="p">(</span>
                    <span class="n">frnxmod</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epo_srt_ok</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epo_end_ok</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">write_in_table_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ++ update table if things go wrong</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_in_table_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">])</span>
            <span class="c1"># raise e</span>

        <span class="k">return</span> <span class="n">frnxmod</span></div>


<div class="viewcode-block" id="StepGnss.mono_mv_final">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_mv_final">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_mv_final</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;on row&quot; method</span>

<span class="sd">        Moves the &#39;table_col&#39; entry to a final destination based **on out_dir** for each row of the table.</span>

<span class="sd">        This method is applied on each row of the table. It checks if the &#39;ok_out&#39; column is True for the row.</span>
<span class="sd">        If it is, it moves the file specified in the &#39;table_col&#39; column to a final destination directory</span>
<span class="sd">        **based on out_dir**.</span>
<span class="sd">        The final destination directory is either provided as an argument or</span>
<span class="sd">         it defaults to the &#39;out_dir&#39; attribute of the object.</span>
<span class="sd">        The method also updates the &#39;ok_out&#39;, &#39;table_col&#39;, and &#39;size_out&#39; columns of the table</span>
<span class="sd">        for the row based on the success of the operation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table on which the method is applied.</span>
<span class="sd">        out_dir : str, optional</span>
<span class="sd">            The directory to which the file is moved.</span>
<span class="sd">             If not provided, the &#39;out_dir&#39; attribute of the object is used.</span>
<span class="sd">        table_col : str, optional</span>
<span class="sd">            The column in the table which contains the file path to be moved.</span>
<span class="sd">            Defaults to &#39;fpath_out&#39;.</span>
<span class="sd">        copy_only : bool, optional</span>
<span class="sd">            If True, the file is copied to the final destination</span>
<span class="sd">            instead of being moved.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            Force the move/copy if the file already exists</span>
<span class="sd">            Default is False</span>

<span class="sd">        See also mono_mv_inpout</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The final path of the moved file if the operation is successful, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if not self.table.loc[</span>
        <span class="c1">#     irow, &quot;ok_out&quot;</span>
        <span class="c1"># ]:  ### for mv it&#39;s ok_out column the one to check!!!!</span>
        <span class="c1">#     logger.warning(</span>
        <span class="c1">#         &quot;final move skipped (input disabled): %s&quot;,</span>
        <span class="c1">#         self.table.loc[irow, &quot;fname&quot;],</span>
        <span class="c1">#     )</span>
        <span class="c1">#     return None</span>
        <span class="c1"># #NB: for mv it&#39;s ok_out column the one to check</span>

        <span class="n">mvcp</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">copy_only</span> <span class="k">else</span> <span class="s2">&quot;move&quot;</span>
        <span class="c1"># NB: for a final move it&#39;s ok_out column the one to check =&gt; mv_final_mode=True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_ok_check</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="s2">&quot;final &quot;</span> <span class="o">+</span> <span class="n">mvcp</span><span class="p">,</span> <span class="n">mv_final_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># definition of the output directory (after the action)</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span>

        <span class="c1">### def output folders</span>
        <span class="n">outdir_trsl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span>
            <span class="n">out_dir_use</span><span class="p">,</span> <span class="n">make_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">epoch_inp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">file_to_mv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>
        <span class="c1">### vvvvv HERE IS THE MOVE</span>
        <span class="n">file_moved</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">move_copy_core</span><span class="p">(</span>
            <span class="n">file_to_mv</span><span class="p">,</span> <span class="n">outdir_trsl</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="n">copy_only</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span>
        <span class="p">)</span>
        <span class="c1">### ^^^^^ HERE IS THE MOVE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mono_mv_validat</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">file_moved</span><span class="o">=</span><span class="n">file_moved</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="n">table_col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">file_moved</span></div>


<div class="viewcode-block" id="StepGnss.mono_mv_inpout">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_mv_inpout">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_mv_inpout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves or copies the input file to the output file.</span>

<span class="sd">        This method checks if the input file (`fpath_inp`) is valid and then moves or</span>
<span class="sd">        copies it to the output file path (`fpath_out`).</span>
<span class="sd">        It validates the move or copy operation and updates the table accordingly.</span>

<span class="sd">        See also mono_mv_final</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table to process.</span>
<span class="sd">        copy_only : bool, optional</span>
<span class="sd">            If True, the file is copied instead of moved. Default is False.</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            Force the move/copy if the file already exists</span>
<span class="sd">            Default is False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The path of the moved or copied file if the operation is successful, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mvcp</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">copy_only</span> <span class="k">else</span> <span class="s2">&quot;move&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mono_ok_check</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">step_name</span><span class="o">=</span><span class="n">mvcp</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">file_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_inp&quot;</span><span class="p">]</span>
        <span class="n">file_des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_out&quot;</span><span class="p">]</span>
        <span class="c1">### vvvvv HERE IS THE MOVE</span>
        <span class="n">file_moved</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">move_copy_core</span><span class="p">(</span>
            <span class="n">file_src</span><span class="p">,</span> <span class="n">file_des</span><span class="p">,</span> <span class="n">copy_only</span><span class="o">=</span><span class="n">copy_only</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span>
        <span class="p">)</span>
        <span class="c1">### ^^^^^ HERE IS THE MOVE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mono_mv_validat</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">file_moved</span><span class="o">=</span><span class="n">file_moved</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_moved</span></div>


<div class="viewcode-block" id="StepGnss.mono_mv_validat">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_mv_validat">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_mv_validat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">file_moved</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_out&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validates the move operation for a file in the table.</span>

<span class="sd">        This method updates the table based on the success of a file move operation.</span>
<span class="sd">        If the file was successfully moved, it updates the &#39;ok_out&#39;, &#39;table_col&#39;, and &#39;size_out&#39; columns.</span>
<span class="sd">        If the file move failed, it sets &#39;ok_out&#39; to False and logs the row in the table log.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table to validate.</span>
<span class="sd">        file_moved : str</span>
<span class="sd">            The path of the moved file. If the move failed, this should be None.</span>
<span class="sd">        table_col : str, optional</span>
<span class="sd">            The column in the table which contains the file path to be moved.</span>
<span class="sd">            Defaults to &#39;fpath_out&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The final path of the moved file if the operation is successful, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">file_moved</span><span class="p">:</span>
            <span class="c1"># Remove the original file if it is still around (normal with a copy rather than a move)</span>
            <span class="c1"># Update table if things go well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_moved</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;size_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_moved</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Update table if things go wrong</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_out&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_in_table_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">])</span>
            <span class="c1"># raise e</span>
        <span class="k">return</span> <span class="n">file_moved</span></div>


<div class="viewcode-block" id="StepGnss.mono_decompress">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_decompress">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_decompress</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_col</span><span class="o">=</span><span class="s2">&quot;fpath_inp&quot;</span><span class="p">,</span> <span class="n">table_ok_col</span><span class="o">=</span><span class="s2">&quot;ok_inp&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;on row&quot; method</span>

<span class="sd">        Decompresses the file specified in the &#39;table_col&#39; entry of a given row in the table.</span>

<span class="sd">        This method checks if the file specified in the &#39;table_col&#39; entry of the given row is compressed.</span>
<span class="sd">        If it is, the method decompresses the file and updates the &#39;table_col&#39; entry with the path</span>
<span class="sd">        of the decompressed file.</span>
<span class="sd">        It also updates the &#39;ok_inp&#39; entry with the existence of the decompressed file and the &#39;fname&#39;</span>
<span class="sd">        entry with the basename of the decompressed file.</span>
<span class="sd">        If the file is not compressed or the &#39;ok_inp&#39; entry is False, the method does nothing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table.</span>
<span class="sd">        out_dir : str, optional</span>
<span class="sd">            The output directory where the decompressed file will be stored. If not provided, the method</span>
<span class="sd">             uses the &#39;tmp_dir_unzipped&#39; attribute if it exists, otherwise it uses the &#39;tmp_dir&#39; attribute.</span>
<span class="sd">        table_col : str, optional</span>
<span class="sd">            The column in the table where the path of the file is stored. Default is &#39;fpath_inp&#39;.</span>
<span class="sd">        table_ok_col : str, optional</span>
<span class="sd">            The column in the table where the boolean indicating the existence of the file is stored.</span>
<span class="sd">            Default is &#39;ok_inp&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str, bool</span>
<span class="sd">            The path of the decompressed file and a boolean indicating whether the file was decompressed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">]:</span>
            <span class="c1"># logger.warning(</span>
            <span class="c1">#    &quot;action on row skipped (input disabled): %s&quot;,</span>
            <span class="c1">#    self.table.loc[irow, &quot;fname&quot;],</span>
            <span class="c1"># )</span>
            <span class="c1"># for decompress the warning message is not necessary and spams the log</span>
            <span class="c1"># (most of the files are not compressed in fact)</span>
            <span class="n">file_decomp_out</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bool_decomp_out</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="n">file_decomp_out</span><span class="p">,</span> <span class="n">bool_decomp_out</span>

        <span class="c1"># definition of the output directory (after the action)</span>
        <span class="k">if</span> <span class="n">out_dir</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;tmp_dir_unzipped&quot;</span><span class="p">):</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir_unzipped</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dir_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span>

        <span class="n">bool_comp</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">is_compressed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">])</span>
        <span class="n">bool_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_ok_col</span><span class="p">]</span>
        <span class="n">bool_wrk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">bool_comp</span><span class="p">,</span> <span class="n">bool_ok</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bool_wrk</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;fpath_ori&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># a &#39;fpath_ori&#39; column must be created first</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;fpath_ori&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_ori&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>

            <span class="n">file_decomp_out</span><span class="p">,</span> <span class="n">bool_decomp_out</span> <span class="o">=</span> <span class="n">arocmn</span><span class="o">.</span><span class="n">decompress_file</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">],</span> <span class="n">out_dir_use</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_decomp_out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_inp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="n">table_col</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_decomp_out</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bool_decomp_out</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">file_decomp_out</span><span class="p">,</span> <span class="n">bool_decomp_out</span></div>


<div class="viewcode-block" id="StepGnss.mono_guess_rnx">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_guess_rnx">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_guess_rnx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Guesses the local RINEX file path for a given row in the table.</span>

<span class="sd">        This method determines the local RINEX file path based on the epoch range</span>
<span class="sd">        and site information for a specific row in the table. It supports both</span>
<span class="sd">        input (`inp`) and output (`out`) modes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table for which the RINEX file path is to be guessed.</span>
<span class="sd">        io : str, optional</span>
<span class="sd">            Specifies whether to guess the input (`inp`) or output (`out`) file path.</span>
<span class="sd">            Default is `out`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The guessed local RINEX file path.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the `io` parameter is not `inp` or `out`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The method ensures that the timezone information is removed from the</span>
<span class="sd">          epoch start and end times to avoid compatibility issues with `rinexmod`.</span>
<span class="sd">        - The guessed file path is stored in the `fpath_&lt;io&gt;` column of the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Determine the directory based on the `io` parameter</span>
        <span class="k">if</span> <span class="n">io</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inp&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;io must be &#39;inp&#39; or &#39;out&#39;&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="n">loc_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="k">if</span> <span class="n">io</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">inp_dir</span><span class="p">)</span>

        <span class="c1"># Retrieve the start and end epochs for the specified row</span>
        <span class="n">epo_srt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_srt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="n">epo_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;epoch_end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>

        <span class="c1"># Remove timezone information to ensure compatibility with `rinexmod`</span>
        <span class="n">epo_srt</span> <span class="o">=</span> <span class="n">epo_srt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">epo_end</span> <span class="o">=</span> <span class="n">epo_end</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Determine the file period string based on the epoch range</span>
        <span class="n">prd_str</span> <span class="o">=</span> <span class="n">rinexmod</span><span class="o">.</span><span class="n">rinexfile</span><span class="o">.</span><span class="n">file_period_from_timedelta</span><span class="p">(</span><span class="n">epo_srt</span><span class="p">,</span> <span class="n">epo_end</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Generate the RINEX file name using site and session information</span>
        <span class="n">loc_fname</span> <span class="o">=</span> <span class="n">conv</span><span class="o">.</span><span class="n">statname_dt2rinexname_long</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">site_id9</span><span class="p">,</span>
            <span class="n">epo_srt</span><span class="p">,</span>
            <span class="n">country</span><span class="o">=</span><span class="s2">&quot;XXX&quot;</span><span class="p">,</span>  <span class="c1"># `site_id9` includes the country</span>
            <span class="n">data_source</span><span class="o">=</span><span class="s2">&quot;R&quot;</span><span class="p">,</span>  <span class="c1"># Always &quot;R&quot; for autorino</span>
            <span class="n">file_period</span><span class="o">=</span><span class="n">prd_str</span><span class="p">,</span>
            <span class="n">data_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;data_frequency&quot;</span><span class="p">],</span>
            <span class="n">data_type</span><span class="o">=</span><span class="s2">&quot;MO&quot;</span><span class="p">,</span>
            <span class="n">format_compression</span><span class="o">=</span><span class="s2">&quot;crx.gz&quot;</span><span class="p">,</span>
            <span class="n">preset_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Construct the full file path and translate it</span>
        <span class="n">loc_path0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loc_dir</span><span class="p">,</span> <span class="n">loc_fname</span><span class="p">)</span>
        <span class="n">loc_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_path</span><span class="p">(</span><span class="n">loc_path0</span><span class="p">,</span> <span class="n">epoch_inp</span><span class="o">=</span><span class="n">epo_srt</span><span class="p">)</span>
        <span class="n">loc_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">loc_path</span><span class="p">)</span>

        <span class="c1"># Update the table with the guessed file path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc_path</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;local RINEX file guessed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loc_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loc_path</span></div>


<div class="viewcode-block" id="StepGnss.mono_chk_local">
<a class="viewcode-back" href="../../../autorino.common.html#autorino.common.step_cls.StepGnss.mono_chk_local">[docs]</a>
    <span class="k">def</span> <span class="nf">mono_chk_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">io</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks the existence and validity of a local file for a specific row in the table.</span>

<span class="sd">        This method verifies if the file specified in the `fpath_&lt;io&gt;` column of the table exists</span>
<span class="sd">        and is non-empty. It updates the corresponding `ok_&lt;io&gt;` and `size_&lt;io&gt;` columns in the table</span>
<span class="sd">        based on the file&#39;s existence and size.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        irow : int</span>
<span class="sd">            The index of the row in the table to check.</span>
<span class="sd">        io : str, optional</span>
<span class="sd">            Specifies whether to check the input (`inp`) or output (`out`) file path.</span>
<span class="sd">            Default is `out`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str or None</span>
<span class="sd">            The absolute path of the file if it exists and is valid, otherwise None.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - If the file path is not initialized (NaN), the method sets `ok_&lt;io&gt;` to False.</span>
<span class="sd">        - If the file exists and is non-empty, the method sets `ok_&lt;io&gt;` to True and updates `size_&lt;io&gt;`</span>
<span class="sd">          with the file size.</span>
<span class="sd">        - If the file does not exist or is empty, the method sets `ok_&lt;io&gt;` to False and `size_&lt;io&gt;` to NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;fpath_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loc_file</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loc_file</span><span class="p">):</span>
            <span class="c1">### if not initialized, value is NaN (and then a float)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">loc_file_out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loc_file_abs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">loc_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loc_file_abs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">loc_file_abs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;size_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">loc_file_abs</span><span class="p">)</span>
                <span class="n">loc_file_out</span> <span class="o">=</span> <span class="n">loc_file_abs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;ok_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">irow</span><span class="p">,</span> <span class="s2">&quot;size_&quot;</span> <span class="o">+</span> <span class="n">io</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">loc_file_out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">loc_file_out</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025 - Pierre Sakic.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>